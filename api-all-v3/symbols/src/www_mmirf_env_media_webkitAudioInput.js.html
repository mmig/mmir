<html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"> <style>
	.KEYW {color: #933;}
	.COMM {color: #bbb; font-style: italic;}
	.NUMB {color: #393;}
	.STRN {color: #393;}
	.REGX {color: #339;}
	.line {border-right: 1px dotted #666; color: #666; font-style: normal;}
	</style></head><body><pre><span class='line'>  1</span> <span class="TOKN">ï»¿</span><span class="COMM">/*
<span class='line'>  2</span>  * 	Copyright (C) 2012-2013 DFKI GmbH
<span class='line'>  3</span>  * 	Deutsches Forschungszentrum fuer Kuenstliche Intelligenz
<span class='line'>  4</span>  * 	German Research Center for Artificial Intelligence
<span class='line'>  5</span>  * 	http://www.dfki.de
<span class='line'>  6</span>  * 
<span class='line'>  7</span>  * 	Permission is hereby granted, free of charge, to any person obtaining a 
<span class='line'>  8</span>  * 	copy of this software and associated documentation files (the 
<span class='line'>  9</span>  * 	"Software"), to deal in the Software without restriction, including 
<span class='line'> 10</span>  * 	without limitation the rights to use, copy, modify, merge, publish, 
<span class='line'> 11</span>  * 	distribute, sublicense, and/or sell copies of the Software, and to 
<span class='line'> 12</span>  * 	permit persons to whom the Software is furnished to do so, subject to 
<span class='line'> 13</span>  * 	the following conditions:
<span class='line'> 14</span>  * 
<span class='line'> 15</span>  * 	The above copyright notice and this permission notice shall be included 
<span class='line'> 16</span>  * 	in all copies or substantial portions of the Software.
<span class='line'> 17</span>  * 
<span class='line'> 18</span>  * 	THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS 
<span class='line'> 19</span>  * 	OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF 
<span class='line'> 20</span>  * 	MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. 
<span class='line'> 21</span>  * 	IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY 
<span class='line'> 22</span>  * 	CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, 
<span class='line'> 23</span>  * 	TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE 
<span class='line'> 24</span>  * 	SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
<span class='line'> 25</span>  */</span><span class="WHIT">
<span class='line'> 26</span> 
<span class='line'> 27</span> </span><span class="NAME">newMediaPlugin</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'> 28</span> 
<span class='line'> 29</span> </span><span class="WHIT">		</span><span class="COMM">/**  @memberOf WebkitAudioInput# */</span><span class="WHIT">
<span class='line'> 30</span> </span><span class="WHIT">		</span><span class="NAME">initialize</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">callBack</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">mediaManager</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">logvalue</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'> 31</span> </span><span class="WHIT">			</span><span class="WHIT">
<span class='line'> 32</span> </span><span class="WHIT">			</span><span class="WHIT">
<span class='line'> 33</span> </span><span class="WHIT">			</span><span class="COMM">////////////////// START MIC-LEVELS: analyzer for microphone-levels-changed & listener mechanism ////////////</span><span class="WHIT">
<span class='line'> 34</span> </span><span class="WHIT">			</span><span class="COMM">/**  
<span class='line'> 35</span> 			 * @type navigator
<span class='line'> 36</span> 			 * @memberOf WebkitAudioInput#
<span class='line'> 37</span> 			 */</span><span class="WHIT">
<span class='line'> 38</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">html5Navigator</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">navigator</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 39</span> </span><span class="WHIT">			</span><span class="COMM">/**
<span class='line'> 40</span> 			 * @type AudioContext
<span class='line'> 41</span> 			 * @memberOf WebkitAudioInput#
<span class='line'> 42</span> 			 */</span><span class="WHIT">
<span class='line'> 43</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">_audioContext</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 44</span> </span><span class="WHIT">			</span><span class="COMM">/**  @memberOf WebkitAudioInput# */</span><span class="WHIT">
<span class='line'> 45</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">nonFunctional</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 46</span> </span><span class="WHIT">			</span><span class="KEYW">try</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'> 47</span> </span><span class="WHIT">		        </span><span class="COMM">// unify the different kinds of HTML5 implementations</span><span class="WHIT">
<span class='line'> 48</span> </span><span class="WHIT">				</span><span class="COMM">//window.AudioContext = window.AudioContext || window.webkitAudioContext;</span><span class="WHIT">
<span class='line'> 49</span> </span><span class="WHIT">				</span><span class="NAME">html5Navigator.__getUserMedia</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">html5Navigator.getUserMedia</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">html5Navigator.webkitGetUserMedia</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">html5Navigator.mozGetUserMedia</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 50</span> </span><span class="WHIT">				</span><span class="COMM">//window.URL = window.URL || window.webkitURL;</span><span class="WHIT">
<span class='line'> 51</span> </span><span class="COMM">//		    	_audioContext = new webkitAudioContext;</span><span class="WHIT">
<span class='line'> 52</span> 
<span class='line'> 53</span> </span><span class="WHIT">				</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="KEYW">typeof</span><span class="WHIT"> </span><span class="NAME">AudioContext</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="STRN">'undefined'</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'> 54</span> </span><span class="WHIT">					</span><span class="NAME">_audioContext</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">AudioContext</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 55</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'> 56</span> </span><span class="WHIT">				</span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="COMM">//if(typeof webkitAudioContext !== 'undefined'){</span><span class="WHIT">
<span class='line'> 57</span> </span><span class="WHIT">					</span><span class="NAME">_audioContext</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">webkitAudioContext</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 58</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'> 59</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="WHIT">
<span class='line'> 60</span> </span><span class="WHIT">			</span><span class="KEYW">catch</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">e</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'> 61</span> </span><span class="WHIT">				</span><span class="NAME">console.error</span><span class="PUNC">(</span><span class="STRN">'No web audio support in this browser! Error: '</span><span class="PUNC">+</span><span class="PUNC">(</span><span class="NAME">e.stack</span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">e.stack</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">e</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 62</span> </span><span class="WHIT">				</span><span class="NAME">nonFunctional</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 63</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'> 64</span> </span><span class="WHIT">			</span><span class="COMM">/**
<span class='line'> 65</span> 			 * Switch for generally disabling "microphone-level changed" calculations
<span class='line'> 66</span> 			 * (otherwise calculation becomes active/inactive depending on whether or 
<span class='line'> 67</span> 			 *  not a listener is registered to event {@link #MIC_CHANGED_EVT_NAME})
<span class='line'> 68</span> 			 *  
<span class='line'> 69</span> 			 * &lt;p>
<span class='line'> 70</span> 			 * TODO make this configurable?...
<span class='line'> 71</span> 			 *  
<span class='line'> 72</span> 			 * @memberOf WebkitAudioInput#
<span class='line'> 73</span> 			 */</span><span class="WHIT">
<span class='line'> 74</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">isMicLevelsEnabled</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 75</span> </span><span class="WHIT">			</span><span class="COMM">/** MIC-LEVELS: the maximal value to occurs in the input data
<span class='line'> 76</span> 			 * &lt;p>
<span class='line'> 77</span> 			 * FIXME verify / check if this is really the maximal possible value...
<span class='line'> 78</span> 			 * @contant
<span class='line'> 79</span> 			 * @memberOf WebkitAudioInput#
<span class='line'> 80</span> 			 */</span><span class="WHIT">
<span class='line'> 81</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">MIC_MAX_VAL</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">2</span><span class="PUNC">;</span><span class="COMM">//</span><span class="WHIT">
<span class='line'> 82</span> </span><span class="WHIT">			</span><span class="COMM">/** MIC-LEVELS: the maximal value for level changes (used for normalizing change-values)
<span class='line'> 83</span> 			 * @constant
<span class='line'> 84</span> 			 * @memberOf WebkitAudioInput# */</span><span class="WHIT">
<span class='line'> 85</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">MIC_MAX_NORM_VAL</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="NUMB">90</span><span class="PUNC">;</span><span class="COMM">// -90 dB ... ???</span><span class="WHIT">
<span class='line'> 86</span> </span><span class="WHIT">			</span><span class="WHIT">
<span class='line'> 87</span> </span><span class="WHIT">			</span><span class="COMM">/** MIC-LEVELS: normalization factor for values: adjust value, so that is 
<span class='line'> 88</span> 			 *              more similar to the results from the other input-modules
<span class='line'> 89</span> 			 * @constant
<span class='line'> 90</span> 			 * @memberOf WebkitAudioInput# */</span><span class="WHIT">
<span class='line'> 91</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">MIC_NORMALIZATION_FACTOR</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">3.5</span><span class="PUNC">;</span><span class="COMM">//adjust value, so that is more similar to the results from the other input-modules</span><span class="WHIT">
<span class='line'> 92</span> </span><span class="WHIT">			</span><span class="COMM">/** MIC-LEVELS: time interval / pauses between calculating level changes
<span class='line'> 93</span> 			 * @constant
<span class='line'> 94</span> 			 * @memberOf WebkitAudioInput# */</span><span class="WHIT">
<span class='line'> 95</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">MIC_QUERY_INTERVALL</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">128</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 96</span> </span><span class="WHIT">			</span><span class="COMM">/** MIC-LEVELS: threshold for calculating level changes
<span class='line'> 97</span> 			 * @constant
<span class='line'> 98</span> 			 * @memberOf WebkitAudioInput# */</span><span class="WHIT">
<span class='line'> 99</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">LEVEL_CHANGED_THRESHOLD</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">1.5</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>100</span> </span><span class="WHIT">			</span><span class="COMM">/**
<span class='line'>101</span> 			 * MIC-LEVELS: Name for the event that is emitted, when the input-mircophone's level change.
<span class='line'>102</span> 			 * 
<span class='line'>103</span> 			 * @private
<span class='line'>104</span> 			 * @constant
<span class='line'>105</span> 			 * @memberOf WebkitAudioInput#
<span class='line'>106</span> 			 */</span><span class="WHIT">
<span class='line'>107</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">MIC_CHANGED_EVT_NAME</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">'miclevelchanged'</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>108</span> </span><span class="WHIT">			</span><span class="WHIT">
<span class='line'>109</span> </span><span class="WHIT">			</span><span class="COMM">/**
<span class='line'>110</span> 			 * HELPER normalize the levels-changed value to MIC_MAX_NORM_VAL
<span class='line'>111</span> 			 * @deprecated currently un-used
<span class='line'>112</span> 			 * @memberOf WebkitAudioInput#
<span class='line'>113</span> 			 */</span><span class="WHIT">
<span class='line'>114</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">normalize</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">v</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>115</span> </span><span class="WHIT">				</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">MIC_MAX_NORM_VAL</span><span class="WHIT"> </span><span class="PUNC">*</span><span class="WHIT"> </span><span class="NAME">v</span><span class="WHIT"> </span><span class="PUNC">/</span><span class="WHIT"> </span><span class="NAME">MIC_MAX_VAL</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>116</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>117</span> </span><span class="WHIT">			</span><span class="COMM">/**
<span class='line'>118</span> 			 * HELPER calculate the RMS value for list of audio values
<span class='line'>119</span> 			 * @deprecated currently un-used
<span class='line'>120</span> 			 * @memberOf WebkitAudioInput#
<span class='line'>121</span> 			 */</span><span class="WHIT">
<span class='line'>122</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">getRms</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">buffer</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">size</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>123</span> </span><span class="WHIT">				</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">buffer</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">size</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>124</span> </span><span class="WHIT">					</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>125</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>126</span> 
<span class='line'>127</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">sum</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>128</span> </span><span class="WHIT">				</span><span class="KEYW">for</span><span class="PUNC">(</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">size</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="PUNC">++</span><span class="NAME">i</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>129</span> </span><span class="WHIT">					</span><span class="NAME">sum</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">buffer</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>130</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>131</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">avg</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">sum</span><span class="WHIT"> </span><span class="PUNC">/</span><span class="WHIT"> </span><span class="NAME">size</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>132</span> 
<span class='line'>133</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">meansq</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>134</span> </span><span class="WHIT">				</span><span class="KEYW">for</span><span class="PUNC">(</span><span class="NAME">i</span><span class="PUNC">=</span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">size</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="PUNC">++</span><span class="NAME">i</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>135</span> </span><span class="WHIT">					</span><span class="NAME">meansq</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Math.pow</span><span class="PUNC">(</span><span class="NAME">buffer</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NAME">avg</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">2</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="WHIT">
<span class='line'>136</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>137</span> 
<span class='line'>138</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">avgMeansq</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">meansq</span><span class="WHIT"> </span><span class="PUNC">/</span><span class="WHIT"> </span><span class="NAME">size</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>139</span> 
<span class='line'>140</span> </span><span class="WHIT">				</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">Math.sqrt</span><span class="PUNC">(</span><span class="NAME">avgMeansq</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>141</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>142</span> </span><span class="WHIT">			</span><span class="COMM">/**
<span class='line'>143</span> 			 * HELPER determine if a value has change in comparison with a previous value
<span class='line'>144</span> 			 * 		  (taking the LEVEL_CHANGED_THRESHOLD into account)
<span class='line'>145</span> 			 * @memberOf WebkitAudioInput#
<span class='line'>146</span> 			 */</span><span class="WHIT">
<span class='line'>147</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">hasChanged</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">value</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">previousValue</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>148</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">res</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">typeof</span><span class="WHIT"> </span><span class="NAME">previousValue</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">'undefined'</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">Math.abs</span><span class="PUNC">(</span><span class="NAME">value</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NAME">previousValue</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">></span><span class="WHIT"> </span><span class="NAME">LEVEL_CHANGED_THRESHOLD</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>149</span> </span><span class="WHIT">				</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">res</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>150</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>151</span> </span><span class="WHIT">			</span><span class="COMM">/**
<span class='line'>152</span> 			 * @type LocalMediaStream
<span class='line'>153</span> 			 * @memberOf WebkitAudioInput#
<span class='line'>154</span> 			 * @see https://developer.mozilla.org/en-US/docs/Web/API/MediaStream_API#LocalMediaStream
<span class='line'>155</span> 			 */</span><span class="WHIT">
<span class='line'>156</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">_currentInputStream</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>157</span> </span><span class="WHIT">			</span><span class="COMM">/**
<span class='line'>158</span> 			 * @type AnalyserNode
<span class='line'>159</span> 			 * @memberOf WebkitAudioInput#
<span class='line'>160</span> 			 * @see https://developer.mozilla.org/en-US/docs/Web/API/AnalyserNode
<span class='line'>161</span> 			 */</span><span class="WHIT">
<span class='line'>162</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">_audioAnalyzer</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>163</span> </span><span class="WHIT">			</span><span class="WHIT">
<span class='line'>164</span> </span><span class="WHIT">			</span><span class="COMM">/**
<span class='line'>165</span> 			 * HELPER callback for getUserMedia: creates the microphone-levels-changed "analyzer"
<span class='line'>166</span> 			 *        and fires mic-levels-changed events for registered listeners
<span class='line'>167</span> 			 * @param {LocalMediaStream} inputstream
<span class='line'>168</span> 			 * @memberOf WebkitAudioInput#
<span class='line'>169</span> 			 */</span><span class="WHIT">
<span class='line'>170</span> </span><span class="WHIT">			</span><span class="KEYW">function</span><span class="WHIT"> </span><span class="NAME">_startUserMedia</span><span class="PUNC">(</span><span class="NAME">inputstream</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>171</span> </span><span class="WHIT">				</span><span class="NAME">console.log</span><span class="PUNC">(</span><span class="STRN">'webkitAudioInput: start analysing audio input...'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>172</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">buffer</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>173</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">prevDb</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>174</span> </span><span class="WHIT">				</span><span class="WHIT">
<span class='line'>175</span> </span><span class="WHIT">				</span><span class="COMM">//we only need one analysis: if there is one active from a previous start</span><span class="WHIT">
<span class='line'>176</span> </span><span class="WHIT">				</span><span class="COMM">//  -> do stop it, before storing the new inputstream in _currentInputStream</span><span class="WHIT">
<span class='line'>177</span> </span><span class="WHIT">				</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">_currentInputStream</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>178</span> </span><span class="WHIT">					</span><span class="NAME">_stopAudioAnalysis</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>179</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>180</span> 
<span class='line'>181</span> </span><span class="WHIT">				</span><span class="NAME">_currentInputStream</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">inputstream</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>182</span> 
<span class='line'>183</span> </span><span class="WHIT">				</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">_isAnalysisCanceled</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>184</span> </span><span class="WHIT">					</span><span class="COMM">//ASR was stopped, before the audio-stream for the analysis became available:</span><span class="WHIT">
<span class='line'>185</span> </span><span class="WHIT">					</span><span class="COMM">// -> stop analysis now, since ASR is not active (and close the audio stream without doing anything)</span><span class="WHIT">
<span class='line'>186</span> </span><span class="WHIT">					</span><span class="NAME">_stopAudioAnalysis</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>187</span> </span><span class="WHIT">					</span><span class="KEYW">return</span><span class="PUNC">;</span><span class="COMM">//////////////// EARLY EXIT //////////////////////</span><span class="WHIT">
<span class='line'>188</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>189</span> </span><span class="WHIT">				</span><span class="WHIT">
<span class='line'>190</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">inputNode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">_audioContext.createMediaStreamSource</span><span class="PUNC">(</span><span class="NAME">_currentInputStream</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>191</span> 
<span class='line'>192</span> </span><span class="WHIT">				</span><span class="COMM">///////////////////// VIZ ///////////////////</span><span class="WHIT">
<span class='line'>193</span> </span><span class="COMM">//				recorder = recorderInstance;</span><span class="WHIT">
<span class='line'>194</span> 
<span class='line'>195</span> </span><span class="WHIT">				</span><span class="NAME">_audioAnalyzer</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">_audioContext.createAnalyser</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>196</span> </span><span class="WHIT">				</span><span class="NAME">_audioAnalyzer.fftSize</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">2048</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>197</span> </span><span class="COMM">//				_audioAnalyzer.smoothingTimeConstant = 0.9;//NOTE: value 1 will smooth everything *completely* -> do not use 1</span><span class="WHIT">
<span class='line'>198</span> </span><span class="WHIT">				</span><span class="NAME">inputNode.connect</span><span class="PUNC">(</span><span class="NAME">_audioAnalyzer</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>199</span> 
<span class='line'>200</span> </span><span class="COMM">//				audioRecorder = new Recorder( _currentInputStream );</span><span class="WHIT">
<span class='line'>201</span> </span><span class="COMM">//				recorder = new Recorder(_currentInputStream, {workerPath: recorderWorkerPath});</span><span class="WHIT">
<span class='line'>202</span> 
<span class='line'>203</span> </span><span class="COMM">//				updateAnalysers();</span><span class="WHIT">
<span class='line'>204</span> 
<span class='line'>205</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">updateAnalysis</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>206</span> </span><span class="WHIT">					</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">_currentInputStream</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>207</span> </span><span class="WHIT">						</span><span class="KEYW">return</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>208</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>209</span> 
<span class='line'>210</span> </span><span class="WHIT">					</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">size</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">_audioAnalyzer.fftSize</span><span class="PUNC">;</span><span class="COMM">//.frequencyBinCount;//</span><span class="WHIT">
<span class='line'>211</span> </span><span class="WHIT">					</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">data</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">Uint8Array</span><span class="PUNC">(</span><span class="NAME">size</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="COMM">//new Float32Array(size);//</span><span class="WHIT">
<span class='line'>212</span> </span><span class="WHIT">					</span><span class="NAME">_audioAnalyzer.getByteTimeDomainData</span><span class="PUNC">(</span><span class="NAME">data</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="COMM">//.getFloatFrequencyData(data);//.getByteFrequencyData(data);//.getFloatTimeDomainData(data);//</span><span class="WHIT">
<span class='line'>213</span> 
<span class='line'>214</span> </span><span class="WHIT">					</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">min</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">32768</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>215</span> </span><span class="WHIT">					</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">max</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="NUMB">32768</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>216</span> </span><span class="WHIT">					</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">total</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>217</span> </span><span class="WHIT">					</span><span class="KEYW">for</span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">=</span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">size</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="PUNC">++</span><span class="NAME">i</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>218</span> </span><span class="WHIT">						</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">datum</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Math.abs</span><span class="PUNC">(</span><span class="NAME">data</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="WHIT">
<span class='line'>219</span> </span><span class="WHIT">						</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">datum</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">min</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>220</span> </span><span class="WHIT">							</span><span class="NAME">min</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">datum</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>221</span> </span><span class="WHIT">						</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">datum</span><span class="WHIT"> </span><span class="PUNC">></span><span class="WHIT"> </span><span class="NAME">max</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>222</span> </span><span class="WHIT">							</span><span class="NAME">max</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">datum</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>223</span> 
<span class='line'>224</span> </span><span class="WHIT">						</span><span class="NAME">total</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">datum</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>225</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>226</span> </span><span class="WHIT">					</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">avg</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">total</span><span class="WHIT"> </span><span class="PUNC">/</span><span class="WHIT"> </span><span class="NAME">size</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>227</span> </span><span class="COMM">//					console.info('audio ['+min+', '+max+'], avg '+avg);</span><span class="WHIT">
<span class='line'>228</span> 
<span class='line'>229</span> </span><span class="COMM">//					var rms = getRms(data, size);</span><span class="WHIT">
<span class='line'>230</span> </span><span class="COMM">//					var db = 20 * Math.log(rms);// / 0.0002);</span><span class="WHIT">
<span class='line'>231</span> 
<span class='line'>232</span> </span><span class="COMM">//					console.info('audio rms '+rms+', db '+db);</span><span class="WHIT">
<span class='line'>233</span> 
<span class='line'>234</span> </span><span class="WHIT">					</span><span class="COMM">/* RMS stands for Root Mean Square, basically the root square of the
<span class='line'>235</span> 					 * average of the square of each value. */</span><span class="WHIT">
<span class='line'>236</span> </span><span class="WHIT">					</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">rms</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">val</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>237</span> </span><span class="WHIT">					</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">data.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>238</span> </span><span class="WHIT">						</span><span class="NAME">val</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">data</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NAME">avg</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>239</span> </span><span class="WHIT">						</span><span class="NAME">rms</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">val</span><span class="WHIT"> </span><span class="PUNC">*</span><span class="WHIT"> </span><span class="NAME">val</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>240</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>241</span> </span><span class="WHIT">					</span><span class="NAME">rms</span><span class="WHIT"> </span><span class="PUNC">/</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">data.length</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>242</span> </span><span class="WHIT">					</span><span class="NAME">rms</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Math.sqrt</span><span class="PUNC">(</span><span class="NAME">rms</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>243</span> 
<span class='line'>244</span> </span><span class="WHIT">					</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">db</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">rms</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>245</span> </span><span class="COMM">//					console.info('audio rms '+rms);</span><span class="WHIT">
<span class='line'>246</span> 
<span class='line'>247</span> </span><span class="WHIT">					</span><span class="COMM">//actually fire the change-event on all registered listeners:</span><span class="WHIT">
<span class='line'>248</span> </span><span class="WHIT">					</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">hasChanged</span><span class="PUNC">(</span><span class="NAME">db</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">prevDb</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>249</span> </span><span class="COMM">//						console.info('audio rms changed: '+prevDb+' -> '+db);</span><span class="WHIT">
<span class='line'>250</span> </span><span class="WHIT">						</span><span class="NAME">prevDb</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">db</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>251</span> 
<span class='line'>252</span> </span><span class="WHIT">						</span><span class="COMM">//adjust value</span><span class="WHIT">
<span class='line'>253</span> </span><span class="WHIT">						</span><span class="NAME">db</span><span class="WHIT"> </span><span class="PUNC">*</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">MIC_NORMALIZATION_FACTOR</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>254</span> 
<span class='line'>255</span> </span><span class="WHIT">						</span><span class="NAME">mediaManager._fireEvent</span><span class="PUNC">(</span><span class="NAME">MIC_CHANGED_EVT_NAME</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="NAME">db</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>256</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>257</span> 
<span class='line'>258</span> 
<span class='line'>259</span> </span><span class="WHIT">					</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">_isAnalysisActive</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">_currentInputStream</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>260</span> </span><span class="WHIT">						</span><span class="NAME">setTimeout</span><span class="PUNC">(</span><span class="NAME">updateAnalysis</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">MIC_QUERY_INTERVALL</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>261</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>262</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>263</span> </span><span class="WHIT">				</span><span class="NAME">updateAnalysis</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>264</span> </span><span class="WHIT">				</span><span class="COMM">///////////////////// VIZ ///////////////////</span><span class="WHIT">
<span class='line'>265</span> 
<span class='line'>266</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>267</span> </span><span class="WHIT">			</span><span class="WHIT">
<span class='line'>268</span> </span><span class="WHIT">			</span><span class="WHIT">
<span class='line'>269</span> </span><span class="WHIT">			</span><span class="COMM">/** internal flag: is/should mic-levels analysis be active?
<span class='line'>270</span> 			 * @memberOf WebkitAudioInput#
<span class='line'>271</span> 			 */</span><span class="WHIT">
<span class='line'>272</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">_isAnalysisActive</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>273</span> </span><span class="WHIT">			</span><span class="COMM">/** internal flag: is/should mic-levels analysis be active?
<span class='line'>274</span> 			 * @memberOf WebkitAudioInput#
<span class='line'>275</span> 			 */</span><span class="WHIT">
<span class='line'>276</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">_isAnalysisCanceled</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>277</span> </span><span class="WHIT">			</span><span class="COMM">/** HELPER start-up mic-levels analysis (and fire events for registered listeners)
<span class='line'>278</span> 			 * @memberOf WebkitAudioInput#
<span class='line'>279</span> 			 */</span><span class="WHIT">
<span class='line'>280</span> </span><span class="WHIT">			</span><span class="KEYW">function</span><span class="WHIT"> </span><span class="NAME">_startAudioAnalysis</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>281</span> </span><span class="WHIT">				</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">_isAnalysisActive</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>282</span> </span><span class="WHIT">					</span><span class="KEYW">return</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>283</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>284</span> </span><span class="WHIT">				</span><span class="NAME">_isAnalysisCanceled</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>285</span> </span><span class="WHIT">				</span><span class="NAME">_isAnalysisActive</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>286</span> </span><span class="WHIT">				</span><span class="NAME">html5Navigator.__getUserMedia</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="NAME">audio</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">_startUserMedia</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">e</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>287</span> </span><span class="WHIT">					</span><span class="NAME">console.error</span><span class="PUNC">(</span><span class="STRN">"webkitAudioInput: failed _startAudioAnalysis, error for getUserMedia "</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">e</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>288</span> </span><span class="WHIT">					</span><span class="NAME">_isAnalysisActive</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>289</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>290</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>291</span> 
<span class='line'>292</span> </span><span class="WHIT">			</span><span class="COMM">/** HELPER stop mic-levels analysis
<span class='line'>293</span> 			 * @memberOf WebkitAudioInput#
<span class='line'>294</span> 			 */</span><span class="WHIT">
<span class='line'>295</span> </span><span class="WHIT">			</span><span class="KEYW">function</span><span class="WHIT"> </span><span class="NAME">_stopAudioAnalysis</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>296</span> </span><span class="WHIT">				</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">_currentInputStream</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>297</span> </span><span class="WHIT">					</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">stream</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">_currentInputStream</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>298</span> </span><span class="WHIT">					</span><span class="NAME">_currentInputStream</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">void</span><span class="PUNC">(</span><span class="NUMB">0</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>299</span> </span><span class="WHIT">					</span><span class="COMM">//DISABLED: MediaStream.stop() is deprecated -> instead: stop all tracks individually</span><span class="WHIT">
<span class='line'>300</span> </span><span class="COMM">//					stream.stop();</span><span class="WHIT">
<span class='line'>301</span> </span><span class="WHIT">					</span><span class="KEYW">try</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>302</span> </span><span class="WHIT">						</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">stream.active</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>303</span> </span><span class="WHIT">							</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">list</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">stream.getTracks</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">track</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>304</span> </span><span class="WHIT">							</span><span class="KEYW">for</span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">=</span><span class="NAME">list.length</span><span class="PUNC">-</span><span class="NUMB">1</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">>=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="PUNC">--</span><span class="NAME">i</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>305</span> </span><span class="WHIT">								</span><span class="NAME">track</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">list</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>306</span> </span><span class="WHIT">								</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">track.readyState</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="STRN">'ended'</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>307</span> </span><span class="WHIT">									</span><span class="NAME">track.stop</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>308</span> </span><span class="WHIT">								</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>309</span> </span><span class="WHIT">							</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>310</span> </span><span class="WHIT">						</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>311</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">catch</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">err</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>312</span> </span><span class="WHIT">						</span><span class="NAME">console.log</span><span class="PUNC">(</span><span class="STRN">'webkitAudioInput: a problem occured while stopping audio input analysis: '</span><span class="PUNC">+</span><span class="NAME">err</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>313</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>314</span> </span><span class="WHIT">					</span><span class="NAME">_isAnalysisCanceled</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>315</span> </span><span class="WHIT">					</span><span class="NAME">_isAnalysisActive</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>316</span> 
<span class='line'>317</span> </span><span class="WHIT">					</span><span class="NAME">console.log</span><span class="PUNC">(</span><span class="STRN">'webkitAudioInput: stopped analysing audio input!'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>318</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>319</span> </span><span class="WHIT">				</span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">_isAnalysisActive</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>320</span> </span><span class="WHIT">					</span><span class="NAME">console.warn</span><span class="PUNC">(</span><span class="STRN">'webkitAudioInput: stopped analysing audio input process, but no valid audio stream present!'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>321</span> </span><span class="WHIT">					</span><span class="NAME">_isAnalysisCanceled</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>322</span> </span><span class="WHIT">					</span><span class="NAME">_isAnalysisActive</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>323</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>324</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>325</span> 
<span class='line'>326</span> </span><span class="WHIT">			</span><span class="COMM">/** HELPER determine whether to start/stop audio-analysis based on
<span class='line'>327</span> 			 * 		   listeners getting added/removed on the MediaManager
<span class='line'>328</span> 			 * @memberOf WebkitAudioInput#
<span class='line'>329</span> 			 */</span><span class="WHIT">
<span class='line'>330</span> </span><span class="WHIT">			</span><span class="KEYW">function</span><span class="WHIT"> </span><span class="NAME">_updateMicLevelAnalysis</span><span class="PUNC">(</span><span class="NAME">actionType</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">handler</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>331</span> 
<span class='line'>332</span> </span><span class="WHIT">				</span><span class="COMM">//start analysis now, if necessary</span><span class="WHIT">
<span class='line'>333</span> </span><span class="WHIT">				</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="WHIT">		</span><span class="NAME">actionType</span><span class="WHIT"> 			</span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">'added'</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="WHIT">
<span class='line'>334</span> </span><span class="WHIT">						</span><span class="NAME">recording</span><span class="WHIT"> 			</span><span class="PUNC">===</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="WHIT">
<span class='line'>335</span> </span><span class="WHIT">						</span><span class="NAME">_isAnalysisActive</span><span class="WHIT"> 	</span><span class="PUNC">===</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="WHIT">
<span class='line'>336</span> </span><span class="WHIT">						</span><span class="NAME">isMicLevelsEnabled</span><span class="WHIT"> 	</span><span class="PUNC">===</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="WHIT">
<span class='line'>337</span> </span><span class="WHIT">				</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>338</span> </span><span class="WHIT">					</span><span class="NAME">_startAudioAnalysis</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>339</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>340</span> </span><span class="WHIT">				</span><span class="COMM">//stop analysis, if there is no listener anymore </span><span class="WHIT">
<span class='line'>341</span> </span><span class="WHIT">				</span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">actionType</span><span class="WHIT"> 			</span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">'removed'</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="WHIT">
<span class='line'>342</span> </span><span class="WHIT">						</span><span class="NAME">_isAnalysisActive</span><span class="WHIT"> 	</span><span class="PUNC">===</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="WHIT">
<span class='line'>343</span> </span><span class="WHIT">						</span><span class="NAME">mediaManager.hasListeners</span><span class="PUNC">(</span><span class="NAME">MIC_CHANGED_EVT_NAME</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="WHIT">
<span class='line'>344</span> </span><span class="WHIT">				</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>345</span> </span><span class="WHIT">					</span><span class="NAME">_stopAudioAnalysis</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>346</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>347</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>348</span> </span><span class="WHIT">			</span><span class="COMM">//observe changes on listener-list for mic-levels-changed-event</span><span class="WHIT">
<span class='line'>349</span> </span><span class="WHIT">			</span><span class="NAME">mediaManager._addListenerObserver</span><span class="PUNC">(</span><span class="NAME">MIC_CHANGED_EVT_NAME</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">_updateMicLevelAnalysis</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>350</span> </span><span class="WHIT">			</span><span class="WHIT">
<span class='line'>351</span> 
<span class='line'>352</span> </span><span class="WHIT">			</span><span class="COMM">////////////////// START MIC-LEVELS: analyzer for microphone-levels-changed & listener mechanism ////////////</span><span class="WHIT">
<span class='line'>353</span> </span><span class="WHIT">			</span><span class="WHIT">
<span class='line'>354</span> </span><span class="WHIT">			</span><span class="COMM">/** @memberOf WebkitAudioInput# */</span><span class="WHIT">
<span class='line'>355</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">_pluginName</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">'webkitAudioInput'</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>356</span> </span><span class="WHIT">			</span><span class="COMM">/**
<span class='line'>357</span> 			 * @type mmir.LanguageManager
<span class='line'>358</span> 			 * @memberOf WebkitAudioInput#
<span class='line'>359</span> 			 */</span><span class="WHIT">
<span class='line'>360</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">languageManager</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">require</span><span class="PUNC">(</span><span class="STRN">'languageManager'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>361</span> 
<span class='line'>362</span> </span><span class="WHIT">            </span><span class="COMM">//detect feature avaibility:</span><span class="WHIT">
<span class='line'>363</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="KEYW">typeof</span><span class="WHIT"> </span><span class="NAME">webkitSpeechRecognition</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">'undefined'</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>364</span> </span><span class="WHIT">				</span><span class="WHIT">
<span class='line'>365</span> </span><span class="WHIT">				</span><span class="COMM">//... browser does NOT support this speech-input-module: create warning message and dummy functions for the MediaManager</span><span class="WHIT">
<span class='line'>366</span> </span><span class="WHIT">				</span><span class="WHIT">
<span class='line'>367</span> </span><span class="WHIT">				</span><span class="NAME">console.warn</span><span class="PUNC">(</span><span class="STRN">'Could not load webkitAudioInput plugin: API webkitSpeechRecognition is not available!'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>368</span> </span><span class="WHIT">				</span><span class="WHIT">
<span class='line'>369</span> </span><span class="WHIT">				</span><span class="COMM">//FIXME this error message is a quick an dirty hack -- there should be a more general way for defining the error message...</span><span class="WHIT">
<span class='line'>370</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">msg</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">'Unfortunately, your internet browser'</span><span class="WHIT">
<span class='line'>371</span> </span><span class="WHIT">							</span><span class="PUNC">+</span><span class="STRN">'\ndoes not support speech input.'</span><span class="WHIT">
<span class='line'>372</span> </span><span class="WHIT">							</span><span class="PUNC">+</span><span class="STRN">'\n\nPlease use Google Chrome,'</span><span class="WHIT">
<span class='line'>373</span> </span><span class="WHIT">							</span><span class="PUNC">+</span><span class="STRN">'\nif you want to use speech input.'</span><span class="WHIT">
<span class='line'>374</span> </span><span class="WHIT">							</span><span class="PUNC">+</span><span class="STRN">'\n\nhttp://www.google.com/chrome'</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>375</span> </span><span class="WHIT">				</span><span class="WHIT">
<span class='line'>376</span> </span><span class="WHIT">				</span><span class="COMM">//invoke the passed-in initializer-callback and export the public functions:</span><span class="WHIT">
<span class='line'>377</span> </span><span class="WHIT">				</span><span class="NAME">callBack</span><span class="PUNC">(</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>378</span> </span><span class="WHIT">					</span><span class="COMM">/**
<span class='line'>379</span> 					 * @public
<span class='line'>380</span> 					 * @memberOf WebkitAudioInput.dummy.prototype
<span class='line'>381</span> 					 * @see mmir.MediaManager#startRecord
<span class='line'>382</span> 					 */</span><span class="WHIT">
<span class='line'>383</span> </span><span class="WHIT">					</span><span class="NAME">startRecord</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">successCallback</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">failureCallback</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>384</span> </span><span class="WHIT">	    				</span><span class="NAME">alert</span><span class="PUNC">(</span><span class="NAME">msg</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>385</span> </span><span class="WHIT">	    				</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">failureCallback</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>386</span> </span><span class="WHIT">	    					</span><span class="NAME">failureCallback</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>387</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>388</span> </span><span class="WHIT">					</span><span class="COMM">/**
<span class='line'>389</span> 					 * @public
<span class='line'>390</span> 					 * @memberOf WebkitAudioInput.dummy.prototype
<span class='line'>391</span> 					 * @see mmir.MediaManager#startRecord
<span class='line'>392</span> 					 */</span><span class="WHIT">
<span class='line'>393</span> </span><span class="WHIT">					</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">stopRecord</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">successCallback</span><span class="PUNC">,</span><span class="NAME">failureCallback</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>394</span> </span><span class="WHIT">						</span><span class="NAME">alert</span><span class="PUNC">(</span><span class="NAME">msg</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>395</span> </span><span class="WHIT">	    				</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">failureCallback</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>396</span> </span><span class="WHIT">	    					</span><span class="NAME">failureCallback</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>397</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>398</span> </span><span class="WHIT">					</span><span class="COMM">/**
<span class='line'>399</span> 					 * @public
<span class='line'>400</span> 					 * @memberOf WebkitAudioInput.dummy.prototype
<span class='line'>401</span> 					 * @see mmir.MediaManager#startRecord
<span class='line'>402</span> 					 */</span><span class="WHIT">
<span class='line'>403</span> </span><span class="WHIT">					</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">recognize</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">successCallback</span><span class="PUNC">,</span><span class="NAME">failureCallback</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>404</span> </span><span class="WHIT">						</span><span class="NAME">alert</span><span class="PUNC">(</span><span class="NAME">msg</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>405</span> </span><span class="WHIT">	    				</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">failureCallback</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>406</span> </span><span class="WHIT">	    					</span><span class="NAME">failureCallback</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>407</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>408</span> </span><span class="WHIT">					</span><span class="COMM">/**
<span class='line'>409</span> 					 * @public
<span class='line'>410</span> 					 * @memberOf WebkitAudioInput.dummy.prototype
<span class='line'>411</span> 					 * @see mmir.MediaManager#startRecord
<span class='line'>412</span> 					 */</span><span class="WHIT">
<span class='line'>413</span> </span><span class="WHIT">	    			</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">cancelRecognition</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">successCallBack</span><span class="PUNC">,</span><span class="NAME">failureCallBack</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>414</span> </span><span class="WHIT">	    				</span><span class="NAME">alert</span><span class="PUNC">(</span><span class="NAME">msg</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>415</span> </span><span class="WHIT">	    				</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">failureCallback</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>416</span> </span><span class="WHIT">	    					</span><span class="NAME">failureCallback</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>417</span> </span><span class="WHIT">	    			</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>418</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>419</span> </span><span class="WHIT">				</span><span class="KEYW">return</span><span class="PUNC">;</span><span class="COMM">////////////////////// EARLY EXIT ///////////////////////////</span><span class="WHIT">
<span class='line'>420</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>421</span> </span><span class="WHIT">			</span><span class="WHIT">
<span class='line'>422</span> </span><span class="WHIT">			</span><span class="COMM">/**
<span class='line'>423</span> 			 * @constant 
<span class='line'>424</span> 			 * @memberOf WebkitAudioInput# */</span><span class="WHIT">
<span class='line'>425</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">EVENT_RESULT_FIELD</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">"transcript"</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>426</span> </span><span class="WHIT">			</span><span class="COMM">/**
<span class='line'>427</span> 			 * @constant
<span class='line'>428</span> 			 * @memberOf WebkitAudioInput# */</span><span class="WHIT">
<span class='line'>429</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">EVENT_SCORE_FIELD</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">"confidence"</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>430</span> </span><span class="WHIT">			</span><span class="COMM">/**
<span class='line'>431</span> 			 * @constant
<span class='line'>432</span> 			 * @memberOf WebkitAudioInput# */</span><span class="WHIT">
<span class='line'>433</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">UNSTABLE_LIMIT</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0.01</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>434</span> </span><span class="WHIT">			</span><span class="WHIT">
<span class='line'>435</span> </span><span class="WHIT">			</span><span class="COMM">/**
<span class='line'>436</span> 			 * Result types (returned by the native/Cordova plugin)
<span class='line'>437</span> 			 * 
<span class='line'>438</span> 			 * @type Enum
<span class='line'>439</span> 			 * @constant
<span class='line'>440</span> 			 * @memberOf WebkitAudioInput#
<span class='line'>441</span> 			 */</span><span class="WHIT">
<span class='line'>442</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">RESULT_TYPES</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>443</span> </span><span class="WHIT">				</span><span class="STRN">"FINAL"</span><span class="PUNC">:</span><span class="WHIT"> 				</span><span class="STRN">"FINAL"</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>444</span> </span><span class="WHIT">				</span><span class="STRN">"INTERIM"</span><span class="PUNC">:</span><span class="WHIT"> 				</span><span class="STRN">"INTERIM"</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>445</span> </span><span class="WHIT">				</span><span class="STRN">"INTERMEDIATE"</span><span class="PUNC">:</span><span class="WHIT">			</span><span class="STRN">"INTERMEDIATE"</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>446</span> </span><span class="WHIT">				</span><span class="STRN">"RECOGNITION_ERROR"</span><span class="PUNC">:</span><span class="WHIT"> 	</span><span class="STRN">"RECOGNITION_ERROR"</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>447</span> </span><span class="WHIT">				</span><span class="STRN">"RECORDING_BEGIN"</span><span class="PUNC">:</span><span class="WHIT"> 		</span><span class="STRN">"RECORDING_BEGIN"</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>448</span> </span><span class="WHIT">				</span><span class="STRN">"RECORDING_DONE"</span><span class="PUNC">:</span><span class="WHIT"> 		</span><span class="STRN">"RECORDING_DONE"</span><span class="WHIT">
<span class='line'>449</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>450</span> </span><span class="WHIT">			</span><span class="WHIT">
<span class='line'>451</span> </span><span class="WHIT">			</span><span class="COMM">/** @type webkitSpeechRecognition
<span class='line'>452</span> 			 * @memberOf WebkitAudioInput# */</span><span class="WHIT">
<span class='line'>453</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">recognition</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">webkitSpeechRecognition</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>454</span> </span><span class="WHIT">			</span><span class="COMM">/** @type Function
<span class='line'>455</span> 			 * @memberOf WebkitAudioInput# */</span><span class="WHIT">
<span class='line'>456</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">currentSuccessCallback</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>457</span> </span><span class="WHIT">			</span><span class="COMM">/** @type Function
<span class='line'>458</span> 			 * @memberOf WebkitAudioInput# */</span><span class="WHIT">
<span class='line'>459</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">currentFailureCallback</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>460</span> </span><span class="WHIT">			</span><span class="COMM">/** @memberOf WebkitAudioInput# */</span><span class="WHIT">
<span class='line'>461</span> </span><span class="WHIT">            </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">final_recognition_result</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">""</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>462</span> </span><span class="WHIT">			</span><span class="COMM">/** @type Function
<span class='line'>463</span> 			 * @memberOf WebkitAudioInput# */</span><span class="WHIT">
<span class='line'>464</span> </span><span class="WHIT">            </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">default_error_function</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>465</span> </span><span class="WHIT">			</span><span class="COMM">/** @type Function
<span class='line'>466</span> 			 * @memberOf WebkitAudioInput# */</span><span class="WHIT">
<span class='line'>467</span> </span><span class="WHIT">            </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">helper_error_handler</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>468</span> </span><span class="WHIT">            </span><span class="WHIT">
<span class='line'>469</span> </span><span class="WHIT">            </span><span class="WHIT">
<span class='line'>470</span> </span><span class="WHIT">            </span><span class="COMM">// flags</span><span class="WHIT">
<span class='line'>471</span> 
<span class='line'>472</span> </span><span class="WHIT">			</span><span class="COMM">/** @memberOf WebkitAudioInput# */</span><span class="WHIT">
<span class='line'>473</span> </span><span class="WHIT">            </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">recording</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>474</span> </span><span class="WHIT">			</span><span class="COMM">/** @memberOf WebkitAudioInput# */</span><span class="WHIT">
<span class='line'>475</span> </span><span class="WHIT">            </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">active</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>476</span> </span><span class="WHIT">			</span><span class="COMM">/** @memberOf WebkitAudioInput# */</span><span class="WHIT">
<span class='line'>477</span> </span><span class="WHIT">            </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">aborted</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>478</span> </span><span class="COMM">//            var restart_counter = 0;</span><span class="WHIT">
<span class='line'>479</span> </span><span class="WHIT">			</span><span class="COMM">/** @memberOf WebkitAudioInput# */</span><span class="WHIT">
<span class='line'>480</span> </span><span class="WHIT">            </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">intermediate_results</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>481</span> </span><span class="WHIT">            </span><span class="WHIT">
<span class='line'>482</span> 
<span class='line'>483</span> </span><span class="WHIT">			</span><span class="COMM">/** @memberOf WebkitAudioInput# */</span><span class="WHIT">
<span class='line'>484</span> </span><span class="WHIT">            </span><span class="COMM">// loglevel - shows:</span><span class="WHIT">
<span class='line'>485</span> </span><span class="WHIT">            </span><span class="COMM">// 0 - errors</span><span class="WHIT">
<span class='line'>486</span> </span><span class="WHIT">            </span><span class="COMM">// 1 - warning, errors</span><span class="WHIT">
<span class='line'>487</span> </span><span class="WHIT">            </span><span class="COMM">// 2 - info, warning, errors</span><span class="WHIT">
<span class='line'>488</span> </span><span class="WHIT">            </span><span class="COMM">// 3 - logs, info, warning, errors</span><span class="WHIT">
<span class='line'>489</span> </span><span class="WHIT">            </span><span class="COMM">// 4 - debugs, logs, info, warning, errors</span><span class="WHIT">
<span class='line'>490</span> </span><span class="WHIT">            </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">loglevel</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">4</span><span class="PUNC">;</span><span class="COMM">//FIXME logvalue | 0;</span><span class="WHIT">
<span class='line'>491</span> 
<span class='line'>492</span> </span><span class="WHIT">			</span><span class="COMM">/** 
<span class='line'>493</span> 			 * field for storing the previous (main) recontion result
<span class='line'>494</span> 			 * (this is used for calculating "unstable" parts, see {@link #helper_extract_results})
<span class='line'>495</span> 			 * @type String
<span class='line'>496</span> 			 * @memberOf WebkitAudioInput#
<span class='line'>497</span> 			 */</span><span class="WHIT">
<span class='line'>498</span> </span><span class="WHIT">            </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">_prevResult</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>499</span> </span><span class="WHIT">            </span><span class="COMM">/**
<span class='line'>500</span>              * create callback-arguments for ASR-result callback: 
<span class='line'>501</span>              * 
<span class='line'>502</span>              * @returns Array with 
<span class='line'>503</span>              * 		[	String result, 
<span class='line'>504</span>              * 			Number score, 
<span class='line'>505</span>              * 			String type ["INTERIM" | "FINAL" ], 
<span class='line'>506</span>              * 			Array&lt;Results> alternatives,		//OPTIONAL
<span class='line'>507</span>              * 			String unstable						//OPTIONAL (NOTE: not supported by this plugin, i.e. webkitSpeechInput)
<span class='line'>508</span>              * 		]
<span class='line'>509</span>              * 
<span class='line'>510</span> 			 * @memberOf WebkitAudioInput#
<span class='line'>511</span>              */</span><span class="WHIT">
<span class='line'>512</span> </span><span class="WHIT">            </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">helper_extract_results</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">eventResultsObject</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>513</span> </span><span class="WHIT">            	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">res</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>514</span> </span><span class="WHIT">            	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">size</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">eventResultsObject.length</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>515</span> 
<span class='line'>516</span> </span><span class="WHIT">            	</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">size</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>517</span> </span><span class="WHIT">            		</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">res</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>518</span> </span><span class="WHIT">            	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>519</span> 
<span class='line'>520</span> </span><span class="WHIT">            	</span><span class="COMM">//ASSERT size >= 1</span><span class="WHIT">
<span class='line'>521</span> 
<span class='line'>522</span> </span><span class="WHIT">            	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">result</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">eventResultsObject</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NAME">EVENT_RESULT_FIELD</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>523</span> </span><span class="WHIT">            	</span><span class="COMM">// [0]: main result</span><span class="WHIT">
<span class='line'>524</span> </span><span class="WHIT">            	</span><span class="NAME">res.push</span><span class="PUNC">(</span><span class="NAME">result</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>525</span> </span><span class="WHIT">            	</span><span class="COMM">// [1]: main confidence score</span><span class="WHIT">
<span class='line'>526</span> </span><span class="WHIT">            	</span><span class="NAME">res.push</span><span class="PUNC">(</span><span class="NAME">eventResultsObject</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NAME">EVENT_SCORE_FIELD</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>527</span> 
<span class='line'>528</span> </span><span class="WHIT">            	</span><span class="COMM">// [2]: result type</span><span class="WHIT">
<span class='line'>529</span> </span><span class="WHIT">            	</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">eventResultsObject.isFinal</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>530</span> </span><span class="WHIT">            		</span><span class="NAME">res.push</span><span class="PUNC">(</span><span class="NAME">recording</span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">RESULT_TYPES.INTERMEDIATE</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">RESULT_TYPES.FINAL</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>531</span> </span><span class="WHIT">            	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>532</span> </span><span class="WHIT">            	</span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>533</span> </span><span class="WHIT">            		</span><span class="NAME">res.push</span><span class="PUNC">(</span><span class="NAME">RESULT_TYPES.INTERIM</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>534</span> </span><span class="WHIT">            	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>535</span> 
<span class='line'>536</span> </span><span class="WHIT">            	</span><span class="COMM">// [3]: array with alternative results</span><span class="WHIT">
<span class='line'>537</span> </span><span class="WHIT">            	</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">size</span><span class="WHIT"> </span><span class="PUNC">></span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>538</span> </span><span class="WHIT">            		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">altRes</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>539</span> </span><span class="WHIT">            		</span><span class="KEYW">for</span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">=</span><span class="NUMB">1</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">size</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="PUNC">++</span><span class="NAME">i</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>540</span> </span><span class="WHIT">            			</span><span class="NAME">altRes.push</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>541</span> </span><span class="WHIT">            				</span><span class="NAME">result</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">eventResultsObject</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NAME">EVENT_RESULT_FIELD</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>542</span> </span><span class="WHIT">            				</span><span class="NAME">score</span><span class="PUNC">:</span><span class="WHIT">  </span><span class="NAME">eventResultsObject</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NAME">EVENT_SCORE_FIELD</span><span class="PUNC">]</span><span class="WHIT">
<span class='line'>543</span> </span><span class="WHIT">            			</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>544</span> </span><span class="WHIT">            		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>545</span> </span><span class="WHIT">            		</span><span class="NAME">res.push</span><span class="PUNC">(</span><span class="NAME">altRes</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>546</span> </span><span class="WHIT">            	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>547</span> </span><span class="WHIT">            	</span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>548</span> 
<span class='line'>549</span> </span><span class="WHIT">            		</span><span class="COMM">//if no alternative results: add undefined-entry:</span><span class="WHIT">
<span class='line'>550</span> </span><span class="WHIT">            		</span><span class="NAME">res.push</span><span class="PUNC">(</span><span class="KEYW">void</span><span class="PUNC">(</span><span class="NUMB">0</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>551</span> </span><span class="WHIT">            	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>552</span> 
<span class='line'>553</span> </span><span class="WHIT">            	</span><span class="COMM">// [4]: UNSTABLE part for main result</span><span class="WHIT">
<span class='line'>554</span> 
<span class='line'>555</span> </span><span class="WHIT">            	</span><span class="COMM">//NOTE "unstable" part of ASR result is not supported by webkitSpeechInput...</span><span class="WHIT">
<span class='line'>556</span> </span><span class="WHIT">            	</span><span class="COMM">//HACK: detect unstable for non-final results:</span><span class="WHIT">
<span class='line'>557</span> </span><span class="WHIT">            	</span><span class="COMM">//      * set to unstable if confidence is lower than UNSTABLE_LIMIT</span><span class="WHIT">
<span class='line'>558</span> </span><span class="WHIT">            	</span><span class="COMM">//      * otherwise (ie. result is basically STABLE), try </span><span class="WHIT">
<span class='line'>559</span> </span><span class="WHIT">            	</span><span class="COMM">//        to detect an UNSTABLE part using the previous result</span><span class="WHIT">
<span class='line'>560</span> </span><span class="WHIT">            	</span><span class="COMM">//        (if previous result contained more than the current stable one...)</span><span class="WHIT">
<span class='line'>561</span> </span><span class="WHIT">            	</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="WHIT"> </span><span class="NAME">eventResultsObject.isFinal</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>562</span> 
<span class='line'>563</span> </span><span class="WHIT">            		</span><span class="COMM">//set to unstable, if result has a LOW score</span><span class="WHIT">
<span class='line'>564</span> </span><span class="WHIT">            		</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">res</span><span class="PUNC">[</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">&lt;=</span><span class="WHIT"> </span><span class="NAME">UNSTABLE_LIMIT</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>565</span> </span><span class="WHIT">            			</span><span class="COMM">//add result as "unstable":</span><span class="WHIT">
<span class='line'>566</span> </span><span class="WHIT">            			</span><span class="NAME">res.push</span><span class="PUNC">(</span><span class="NAME">result</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>567</span> </span><span class="WHIT">            			</span><span class="COMM">//set main-result to empty</span><span class="WHIT">
<span class='line'>568</span> </span><span class="WHIT">            			</span><span class="NAME">res</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">""</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>569</span> </span><span class="WHIT">            		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>570</span> </span><span class="WHIT">            		</span><span class="COMM">//try to recover unstable part:</span><span class="WHIT">
<span class='line'>571</span> </span><span class="WHIT">            		</span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">res</span><span class="PUNC">[</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">></span><span class="WHIT"> </span><span class="NAME">UNSTABLE_LIMIT</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">_prevResult</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">_prevResult.length</span><span class="WHIT"> </span><span class="PUNC">></span><span class="WHIT"> </span><span class="NAME">length</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>572</span> 
<span class='line'>573</span> </span><span class="WHIT">            			</span><span class="COMM">//try to detect stable part: detect matching prefix with previous result</span><span class="WHIT">
<span class='line'>574</span> </span><span class="WHIT">            			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">prefixIndex</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>575</span> </span><span class="WHIT">            			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">size</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">result.length</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>576</span> </span><span class="WHIT">            			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">ch</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">result.charAt</span><span class="PUNC">(</span><span class="NAME">prefixIndex</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">toLowerCase</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>577</span> </span><span class="WHIT">            			</span><span class="KEYW">while</span><span class="PUNC">(</span><span class="NAME">size</span><span class="WHIT"> </span><span class="PUNC">></span><span class="WHIT"> </span><span class="NAME">prefixIndex</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">ch</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">_prevResult.charAt</span><span class="PUNC">(</span><span class="NAME">prefixIndex</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">toLowerCase</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>578</span> </span><span class="WHIT">            				</span><span class="NAME">ch</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">result.charAt</span><span class="PUNC">(</span><span class="PUNC">++</span><span class="NAME">prefixIndex</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">toLowerCase</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>579</span> </span><span class="WHIT">            			</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>580</span> 
<span class='line'>581</span> </span><span class="WHIT">            			</span><span class="COMM">//-> use REST from matching prefix as UNSTABLE text</span><span class="WHIT">
<span class='line'>582</span> </span><span class="WHIT">            			</span><span class="COMM">//NOTE: use simplification (i.e. simpler code) ignore matches &lt;= 1, ie. prefixIndex > 0</span><span class="WHIT">
<span class='line'>583</span> </span><span class="WHIT">            			</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">prefixIndex</span><span class="WHIT"> </span><span class="PUNC">></span><span class="WHIT"> </span><span class="NUMB">0</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">prefixIndex</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">_prevResult.length</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>584</span> 
<span class='line'>585</span> </span><span class="WHIT">            				</span><span class="COMM">//add REST to detected PREFIX as "unstable":</span><span class="WHIT">
<span class='line'>586</span> </span><span class="WHIT">            				</span><span class="NAME">res.push</span><span class="PUNC">(</span><span class="NAME">_prevResult.substring</span><span class="PUNC">(</span><span class="NAME">prefixIndex</span><span class="PUNC">+</span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>587</span> 
<span class='line'>588</span> </span><span class="WHIT">            				</span><span class="NAME">console.info</span><span class="PUNC">(</span><span class="STRN">'found unstable ASR part: "'</span><span class="PUNC">+</span><span class="NAME">_prevResult.substring</span><span class="PUNC">(</span><span class="NAME">prefixIndex</span><span class="PUNC">+</span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">+</span><span class="STRN">'"'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>589</span> </span><span class="WHIT">            			</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>590</span> </span><span class="WHIT">            			</span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>591</span> </span><span class="WHIT">            				</span><span class="COMM">// -> we have relatively stable result, that has no unstable postfix -> reset _prevResult;</span><span class="WHIT">
<span class='line'>592</span> </span><span class="WHIT">            				</span><span class="NAME">_prevResult</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">void</span><span class="PUNC">(</span><span class="NUMB">0</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>593</span> </span><span class="WHIT">            			</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>594</span> </span><span class="WHIT">            		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>595</span> 
<span class='line'>596</span> </span><span class="WHIT">            		</span><span class="COMM">//remember current (main) result STRING, if it "adds information":</span><span class="WHIT">
<span class='line'>597</span> </span><span class="WHIT">            		</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">_prevResult</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">result.length</span><span class="WHIT"> </span><span class="PUNC">>=</span><span class="WHIT"> </span><span class="NAME">_prevResult.length</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>598</span> </span><span class="WHIT">            			</span><span class="NAME">_prevResult</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">result</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>599</span> </span><span class="WHIT">            		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>600</span> 
<span class='line'>601</span> </span><span class="WHIT">            	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>602</span> </span><span class="WHIT">            	</span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>603</span> </span><span class="WHIT">            		</span><span class="COMM">//if FINAL, reset field for previous-result </span><span class="WHIT">
<span class='line'>604</span> </span><span class="WHIT">            		</span><span class="NAME">_prevResult</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">void</span><span class="PUNC">(</span><span class="NUMB">0</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>605</span> </span><span class="WHIT">            	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>606</span> 
<span class='line'>607</span> 
<span class='line'>608</span> </span><span class="WHIT">            	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">res</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>609</span> </span><span class="WHIT">            </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>610</span> </span><span class="WHIT">            </span><span class="WHIT">
<span class='line'>611</span> </span><span class="WHIT">            </span><span class="COMM">/**
<span class='line'>612</span> 			 * Counter for error-in-a-row: 
<span class='line'>613</span> 			 * each time an error is encountered, this counter is increased.
<span class='line'>614</span> 			 * On starting/canceling, or on an internal success/result callback,
<span class='line'>615</span> 			 * the counter is reset.
<span class='line'>616</span> 			 * 
<span class='line'>617</span> 			 * Thus, this counter keeps track how many times in a row
<span class='line'>618</span> 			 * the (internal) error-callback was triggered.
<span class='line'>619</span> 			 * 
<span class='line'>620</span> 			 * NOTE: this is currently used, to try restarting &lt;code>max_error_retry&lt;/code>
<span class='line'>621</span> 			 * 		 times the ASR, even on "critical" errors (during repeat-mode). 
<span class='line'>622</span> 			 * 
<span class='line'>623</span> 			 * @see #max_error_retry
<span class='line'>624</span> 			 * 
<span class='line'>625</span> 			 * @memberOf AndroidAudioInput#
<span class='line'>626</span> 			 */</span><span class="WHIT">
<span class='line'>627</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">error_counter</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>628</span> </span><span class="WHIT">			</span><span class="WHIT">
<span class='line'>629</span> </span><span class="WHIT">			</span><span class="COMM">/**
<span class='line'>630</span> 			 * Maximal number of errors-in-a-row for trying to restart
<span class='line'>631</span> 			 * recognition in repeat-mode.
<span class='line'>632</span> 			 * 
<span class='line'>633</span> 			 * @see #error_counter
<span class='line'>634</span> 			 * 
<span class='line'>635</span> 			 * @memberOf AndroidAudioInput#
<span class='line'>636</span> 			 * @default 5
<span class='line'>637</span> 			 */</span><span class="WHIT">
<span class='line'>638</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">max_error_retry</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">5</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>639</span> </span><span class="WHIT">            </span><span class="WHIT">
<span class='line'>640</span> </span><span class="WHIT">            </span><span class="COMM">/**
<span class='line'>641</span>              * default helper for error-events:
<span class='line'>642</span>              * 
<span class='line'>643</span>              * determines, if RESTART is allowed/possible (in case of RECORDing mode),
<span class='line'>644</span>              * AND otherwise triggers the current failure-callbacks.
<span class='line'>645</span>              * 
<span class='line'>646</span>              * SIDE-EFFECTS: sets private field aborted:=true if RESTART is NOT possible.
<span class='line'>647</span>              * 
<span class='line'>648</span>              * @returns {Boolean} true, if the function could process the error
<span class='line'>649</span>              * 		 (i.e. return false for unknown errors; these should be handled by 
<span class='line'>650</span>              *        the invoking code of this helper function)
<span class='line'>651</span>              *        
<span class='line'>652</span> 			 * @memberOf WebkitAudioInput#
<span class='line'>653</span>              */</span><span class="WHIT">
<span class='line'>654</span> </span><span class="WHIT">            </span><span class="NAME">helper_error_handler</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">event</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>655</span> </span><span class="WHIT">            	</span><span class="WHIT">
<span class='line'>656</span> </span><span class="WHIT">            	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">type</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">event.error</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>657</span> </span><span class="WHIT">            	</span><span class="WHIT">
<span class='line'>658</span> </span><span class="WHIT">            	</span><span class="KEYW">switch</span><span class="PUNC">(</span><span class="NAME">type</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>659</span> </span><span class="WHIT">            	</span><span class="KEYW">case</span><span class="WHIT"> </span><span class="STRN">"no-speech"</span><span class="PUNC">:</span><span class="WHIT">
<span class='line'>660</span> </span><span class="WHIT">                    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">loglevel</span><span class="WHIT"> </span><span class="PUNC">>=</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>661</span> </span><span class="WHIT">                        </span><span class="NAME">console.info</span><span class="PUNC">(</span><span class="STRN">"[webkitAudioInput.Warn] event "</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">type</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>662</span> </span><span class="WHIT">                    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>663</span> </span><span class="WHIT">                    </span><span class="COMM">// no errorcallback, just restart (if in RECORD mode)...</span><span class="WHIT">
<span class='line'>664</span> </span><span class="WHIT">                    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>665</span> </span><span class="WHIT">                    </span><span class="WHIT">
<span class='line'>666</span> </span><span class="WHIT">                </span><span class="COMM">////////////////</span><span class="WHIT">
<span class='line'>667</span> </span><span class="WHIT">                </span><span class="COMM">// "serious" errors: cannot not automatically restart...</span><span class="WHIT">
<span class='line'>668</span> </span><span class="WHIT">               </span><span class="WHIT">
<span class='line'>669</span> </span><span class="WHIT">                </span><span class="COMM">// Audio capture failed.</span><span class="WHIT">
<span class='line'>670</span> </span><span class="WHIT">            	</span><span class="KEYW">case</span><span class="WHIT"> </span><span class="STRN">"audio-capture"</span><span class="PUNC">:</span><span class="WHIT">
<span class='line'>671</span> </span><span class="WHIT">            		</span><span class="COMM">// if analysing-audio for microphone levels (via getUserMedia)</span><span class="WHIT">
<span class='line'>672</span> </span><span class="WHIT">            		</span><span class="COMM">//    is enabled, the error may have been caused by the browser/device</span><span class="WHIT">
<span class='line'>673</span> </span><span class="WHIT">            		</span><span class="COMM">//    due to the fact, that it does not allow multiple/parallel access</span><span class="WHIT">
<span class='line'>674</span> </span><span class="WHIT">            		</span><span class="COMM">//    to the microphone resource...</span><span class="WHIT">
<span class='line'>675</span> </span><span class="WHIT">            		</span><span class="COMM">// -> try once again, but with disabled analysing-audio feature:</span><span class="WHIT">
<span class='line'>676</span> </span><span class="WHIT">            		</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">isMicLevelsEnabled</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>677</span> </span><span class="WHIT">            			</span><span class="NAME">isMicLevelsEnabled</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>678</span> </span><span class="WHIT">            			</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>679</span> </span><span class="WHIT">            		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>680</span> </span><span class="WHIT">            		</span><span class="WHIT">
<span class='line'>681</span> </span><span class="WHIT">                    </span><span class="COMM">// ...otherwise: do not restart!</span><span class="WHIT">
<span class='line'>682</span> </span><span class="WHIT">                </span><span class="WHIT">
<span class='line'>683</span> </span><span class="WHIT">                </span><span class="COMM">// Some network communication that was required to complete the recognition failed.</span><span class="WHIT">
<span class='line'>684</span> </span><span class="WHIT">            	</span><span class="KEYW">case</span><span class="WHIT"> </span><span class="STRN">"network"</span><span class="PUNC">:</span><span class="WHIT">
<span class='line'>685</span> </span><span class="WHIT">                    </span><span class="COMM">// do not restart!</span><span class="WHIT">
<span class='line'>686</span> </span><span class="WHIT">            		</span><span class="WHIT">
<span class='line'>687</span> </span><span class="WHIT">            		</span><span class="COMM">//for "serious errors": if errors-in-a-row-counter is under the limit, DO try to restart</span><span class="WHIT">
<span class='line'>688</span> </span><span class="WHIT">            		</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">error_counter</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">max_error_retry</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>689</span> </span><span class="WHIT">            			</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>690</span> </span><span class="WHIT">            		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>691</span> </span><span class="WHIT">            	</span><span class="WHIT">
<span class='line'>692</span> </span><span class="WHIT">                </span><span class="COMM">// Speech input was aborted somehow, maybe by some user-agent-specific behavior such as UI that lets the user cancel speech input.</span><span class="WHIT">
<span class='line'>693</span> </span><span class="WHIT">            	</span><span class="KEYW">case</span><span class="WHIT"> </span><span class="STRN">"aborted"</span><span class="PUNC">:</span><span class="WHIT">
<span class='line'>694</span> </span><span class="WHIT">                    </span><span class="COMM">// do not restart!</span><span class="WHIT">
<span class='line'>695</span> </span><span class="WHIT">                    </span><span class="WHIT">
<span class='line'>696</span> </span><span class="WHIT">                </span><span class="COMM">// The user agent is not allowing any speech input to occur for reasons of security, privacy or user preference.</span><span class="WHIT">
<span class='line'>697</span> </span><span class="WHIT">            	</span><span class="KEYW">case</span><span class="WHIT"> </span><span class="STRN">"not-allowed"</span><span class="PUNC">:</span><span class="WHIT">
<span class='line'>698</span> </span><span class="WHIT">                    </span><span class="COMM">// user denied access -> do not automatically restart!</span><span class="WHIT">
<span class='line'>699</span> </span><span class="WHIT">                </span><span class="WHIT">
<span class='line'>700</span> </span><span class="WHIT">                </span><span class="COMM">// The user agent is not allowing the web application requested speech service, but would allow some speech service, to be used either because the user agent doesn't support the selected one or because of reasons of security, privacy or user preference.</span><span class="WHIT">
<span class='line'>701</span> </span><span class="WHIT">            	</span><span class="KEYW">case</span><span class="WHIT"> </span><span class="STRN">"service-not-allowed"</span><span class="PUNC">:</span><span class="WHIT">
<span class='line'>702</span> </span><span class="WHIT">                    </span><span class="COMM">// user agent denied access -> do not automatically restart!</span><span class="WHIT">
<span class='line'>703</span> </span><span class="WHIT">            		</span><span class="WHIT">
<span class='line'>704</span> </span><span class="WHIT">                </span><span class="COMM">// There was an error in the speech recognition grammar or semantic tags, or the grammar format or semantic tag format is unsupported.</span><span class="WHIT">
<span class='line'>705</span> </span><span class="WHIT">            	</span><span class="KEYW">case</span><span class="WHIT"> </span><span class="STRN">"bad-grammar"</span><span class="PUNC">:</span><span class="WHIT">
<span class='line'>706</span> </span><span class="WHIT">                    </span><span class="COMM">// do not automatically restart!</span><span class="WHIT">
<span class='line'>707</span> </span><span class="WHIT">            		</span><span class="WHIT">
<span class='line'>708</span> </span><span class="WHIT">                </span><span class="COMM">// The language was not supported.</span><span class="WHIT">
<span class='line'>709</span> </span><span class="WHIT">            	</span><span class="KEYW">case</span><span class="WHIT"> </span><span class="STRN">"language-not-supported"</span><span class="PUNC">:</span><span class="WHIT">
<span class='line'>710</span> </span><span class="WHIT">                    </span><span class="COMM">// do not automatically restart!, change the language</span><span class="WHIT">
<span class='line'>711</span> </span><span class="WHIT">                    </span><span class="NAME">aborted</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>712</span> </span><span class="WHIT">                    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">loglevel</span><span class="WHIT"> </span><span class="PUNC">>=</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>713</span> </span><span class="WHIT">                        </span><span class="NAME">console.warn</span><span class="PUNC">(</span><span class="STRN">"[webkitAudioInput.Warn] event "</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">type</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>714</span> </span><span class="WHIT">                    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>715</span> </span><span class="WHIT">                    </span><span class="NAME">currentFailureCallback</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">currentFailureCallback</span><span class="PUNC">(</span><span class="NAME">event.error</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>716</span> </span><span class="WHIT">                    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>717</span> </span><span class="WHIT">                    </span><span class="WHIT">
<span class='line'>718</span> </span><span class="WHIT">            	</span><span class="KEYW">default</span><span class="PUNC">:</span><span class="WHIT">
<span class='line'>719</span> </span><span class="WHIT">                	</span><span class="COMM">//for unknown errors: return false</span><span class="WHIT">
<span class='line'>720</span> </span><span class="WHIT">            		</span><span class="KEYW">break</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>721</span> </span><span class="WHIT">            		</span><span class="WHIT">
<span class='line'>722</span> </span><span class="WHIT">            	</span><span class="PUNC">}</span><span class="COMM">//END: switch</span><span class="WHIT">
<span class='line'>723</span> </span><span class="WHIT">            	</span><span class="WHIT">
<span class='line'>724</span> </span><span class="WHIT">            	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>725</span> </span><span class="WHIT">            </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="COMM">//END: helper_error_handler(event){...</span><span class="WHIT">
<span class='line'>726</span> </span><span class="WHIT">            </span><span class="WHIT">
<span class='line'>727</span> </span><span class="WHIT">            </span><span class="COMM">/** @memberOf WebkitAudioInput# */</span><span class="WHIT">
<span class='line'>728</span> </span><span class="WHIT">            </span><span class="NAME">default_error_function</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">event</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>729</span> </span><span class="WHIT">            	</span><span class="WHIT">
<span class='line'>730</span> </span><span class="WHIT">            	</span><span class="PUNC">++</span><span class="NAME">error_counter</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>731</span> </span><span class="WHIT">            	</span><span class="WHIT">
<span class='line'>732</span> </span><span class="COMM">//                if (helper_error_handler.hasOwnProperty(event.error)){</span><span class="WHIT">
<span class='line'>733</span> </span><span class="COMM">//                    helper_error_handler[event.error](event);</span><span class="WHIT">
<span class='line'>734</span> </span><span class="COMM">//                } else {</span><span class="WHIT">
<span class='line'>735</span> </span><span class="WHIT">            	</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="WHIT"> </span><span class="NAME">helper_error_handler</span><span class="PUNC">(</span><span class="NAME">event</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>736</span> </span><span class="WHIT">            		</span><span class="WHIT">
<span class='line'>737</span> </span><span class="WHIT">                    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">currentFailureCallback</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>738</span> </span><span class="WHIT">                        </span><span class="NAME">currentFailureCallback</span><span class="PUNC">(</span><span class="NAME">event.error</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>739</span> </span><span class="WHIT">                    </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>740</span> </span><span class="WHIT">                        </span><span class="NAME">console.error</span><span class="PUNC">(</span><span class="STRN">"[webkitAudioInput.Error] event "</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">event.error</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>741</span> </span><span class="WHIT">                    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>742</span> </span><span class="WHIT">                </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>743</span> </span><span class="WHIT">            </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>744</span> </span><span class="WHIT">            </span><span class="WHIT">
<span class='line'>745</span> </span><span class="WHIT">            </span><span class="COMM">// set remaining event-handler functions</span><span class="WHIT">
<span class='line'>746</span> </span><span class="WHIT">            </span><span class="WHIT">
<span class='line'>747</span> </span><span class="WHIT">            </span><span class="COMM">/**
<span class='line'>748</span>              * Side-Effects:
<span class='line'>749</span>              * 
<span class='line'>750</span>              * sets recognition-status to "active"
<span class='line'>751</span>              * 
<span class='line'>752</span>              * starts audio-analysis (if listeners are registered for mic-levels-changed event)
<span class='line'>753</span>              * 
<span class='line'>754</span>              * @memberOf WebkitAudioInput.recognition#
<span class='line'>755</span>              */</span><span class="WHIT">
<span class='line'>756</span> </span><span class="WHIT">            </span><span class="NAME">recognition.onaudiostart</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">event</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>757</span> </span><span class="WHIT">                </span><span class="NAME">active</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>758</span> </span><span class="WHIT">                </span><span class="COMM">// if audio can start, then we have been successful in starting the voice recognition</span><span class="WHIT">
<span class='line'>759</span> </span><span class="WHIT">                </span><span class="COMM">// so: reset counter</span><span class="WHIT">
<span class='line'>760</span> </span><span class="WHIT">                </span><span class="COMM">// TODO: check if this is really correct</span><span class="WHIT">
<span class='line'>761</span> </span><span class="COMM">//                restart_counter=0;</span><span class="WHIT">
<span class='line'>762</span> </span><span class="WHIT">                </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">loglevel</span><span class="WHIT"> </span><span class="PUNC">>=</span><span class="WHIT"> </span><span class="NUMB">4</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>763</span> </span><span class="WHIT">                	</span><span class="NAME">console.debug</span><span class="PUNC">(</span><span class="STRN">"[webkitAudioInput.Debug] Audio START"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>764</span> </span><span class="WHIT">                	</span><span class="NAME">console.debug</span><span class="PUNC">(</span><span class="STRN">"[webkitAudioInput.Debug] active: "</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">active</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>765</span> </span><span class="WHIT">                </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>766</span> </span><span class="WHIT">                </span><span class="WHIT">
<span class='line'>767</span> </span><span class="WHIT">                </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">isMicLevelsEnabled</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>768</span> </span><span class="WHIT">                	</span><span class="NAME">_startAudioAnalysis</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>769</span> </span><span class="WHIT">                </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>770</span> </span><span class="WHIT">            </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>771</span> </span><span class="WHIT">            </span><span class="COMM">/** @memberOf WebkitAudioInput.recognition# */</span><span class="WHIT">
<span class='line'>772</span> </span><span class="WHIT">            </span><span class="NAME">recognition.onspeechstart</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">event</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>773</span> </span><span class="WHIT">                </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">loglevel</span><span class="WHIT"> </span><span class="PUNC">>=</span><span class="WHIT"> </span><span class="NUMB">4</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>774</span> </span><span class="WHIT">                	</span><span class="NAME">console.debug</span><span class="PUNC">(</span><span class="STRN">"[webkitAudioInput.Debug] Speech START"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>775</span> </span><span class="WHIT">                </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>776</span> </span><span class="WHIT">            </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>777</span> </span><span class="WHIT">            </span><span class="COMM">/** @memberOf WebkitAudioInput.recognition# */</span><span class="WHIT">
<span class='line'>778</span> </span><span class="WHIT">            </span><span class="NAME">recognition.onsoundstart</span><span class="WHIT">  </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">event</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>779</span> </span><span class="WHIT">                </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">loglevel</span><span class="WHIT"> </span><span class="PUNC">>=</span><span class="WHIT"> </span><span class="NUMB">4</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>780</span> </span><span class="WHIT">                	</span><span class="NAME">console.debug</span><span class="PUNC">(</span><span class="STRN">"[webkitAudioInput.Debug] Sound  START"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>781</span> </span><span class="WHIT">                </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>782</span> </span><span class="WHIT">            </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>783</span> </span><span class="WHIT">            </span><span class="COMM">/** @memberOf WebkitAudioInput.recognition# */</span><span class="WHIT">
<span class='line'>784</span> </span><span class="WHIT">            </span><span class="NAME">recognition.onaudioend</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">event</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>785</span> </span><span class="WHIT">                </span><span class="NAME">active</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>786</span> </span><span class="WHIT">                </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">loglevel</span><span class="WHIT"> </span><span class="PUNC">>=</span><span class="WHIT"> </span><span class="NUMB">4</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>787</span> </span><span class="WHIT">                	</span><span class="NAME">console.debug</span><span class="PUNC">(</span><span class="STRN">"[webkitAudioInput.Debug] Audio END"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>788</span> </span><span class="WHIT">                </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>789</span> 
<span class='line'>790</span> </span><span class="COMM">//                _stopAudioAnalysis(); MOVED to onend: in some cases, onaudioend will not be triggered, but onend will always get triggered</span><span class="WHIT">
<span class='line'>791</span> </span><span class="WHIT">            </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>792</span> </span><span class="WHIT">            </span><span class="COMM">/** @memberOf WebkitAudioInput.recognition# */</span><span class="WHIT">
<span class='line'>793</span> </span><span class="WHIT">            </span><span class="NAME">recognition.onspeechend</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">event</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>794</span> </span><span class="WHIT">                </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">loglevel</span><span class="WHIT"> </span><span class="PUNC">>=</span><span class="WHIT"> </span><span class="NUMB">4</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>795</span> </span><span class="WHIT">                	</span><span class="NAME">console.debug</span><span class="PUNC">(</span><span class="STRN">"[webkitAudioInput.Debug] Speech END"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>796</span> </span><span class="WHIT">                </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>797</span> </span><span class="WHIT">            </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>798</span> </span><span class="WHIT">            </span><span class="COMM">/** @memberOf WebkitAudioInput.recognition# */</span><span class="WHIT">
<span class='line'>799</span> </span><span class="WHIT">            </span><span class="NAME">recognition.onsoundend</span><span class="WHIT">  </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">event</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>800</span> </span><span class="WHIT">                </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">loglevel</span><span class="WHIT"> </span><span class="PUNC">>=</span><span class="WHIT"> </span><span class="NUMB">4</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>801</span> </span><span class="WHIT">                	</span><span class="NAME">console.debug</span><span class="PUNC">(</span><span class="STRN">"[webkitAudioInput.Debug] Sound  END"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>802</span> </span><span class="WHIT">                </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>803</span> </span><span class="WHIT">            </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>804</span> </span><span class="WHIT">            </span><span class="COMM">/** @memberOf WebkitAudioInput.recognition# */</span><span class="WHIT">
<span class='line'>805</span> </span><span class="WHIT">            </span><span class="NAME">recognition.onstart</span><span class="WHIT">  </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">event</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>806</span> </span><span class="WHIT">                </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">loglevel</span><span class="WHIT"> </span><span class="PUNC">>=</span><span class="WHIT"> </span><span class="NUMB">4</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>807</span> </span><span class="WHIT">                	</span><span class="NAME">console.debug</span><span class="PUNC">(</span><span class="STRN">"[webkitAudioInput.Debug] asr START"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>808</span> </span><span class="WHIT">                </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>809</span> </span><span class="WHIT">            </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>810</span> </span><span class="WHIT">            </span><span class="COMM">/**
<span class='line'>811</span>              * Side-Effects:
<span class='line'>812</span>              * 
<span class='line'>813</span>              * sets recognition-status to "inactive"
<span class='line'>814</span>              * 
<span class='line'>815</span>              * re-starts recognition if in "recoring" mode OR calls stopped-callback
<span class='line'>816</span>              * 
<span class='line'>817</span>              * @memberOf WebkitAudioInput.recognition#
<span class='line'>818</span>              */</span><span class="WHIT">
<span class='line'>819</span> </span><span class="WHIT">            </span><span class="NAME">recognition.onend</span><span class="WHIT">  </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">event</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>820</span> </span><span class="WHIT">                </span><span class="NAME">active</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>821</span> </span><span class="WHIT">                </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">loglevel</span><span class="WHIT"> </span><span class="PUNC">>=</span><span class="WHIT"> </span><span class="NUMB">4</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>822</span> </span><span class="WHIT">                	</span><span class="NAME">console.debug</span><span class="PUNC">(</span><span class="STRN">"[webkitAudioInput.Debug] asr END"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>823</span> </span><span class="WHIT">                	</span><span class="NAME">console.debug</span><span class="PUNC">(</span><span class="STRN">"[webkitAudioInput.Debug] active: "</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">active</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>824</span> </span><span class="WHIT">                </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>825</span> </span><span class="WHIT">                </span><span class="WHIT">
<span class='line'>826</span> </span><span class="WHIT">                </span><span class="COMM">//NOTE there may be no analysis open, but stopping here (and not e.g. in onaudioen) </span><span class="WHIT">
<span class='line'>827</span> </span><span class="WHIT">                </span><span class="COMM">//     will ensure that we _always_ remove analysis, if it is present:</span><span class="WHIT">
<span class='line'>828</span> </span><span class="WHIT">                </span><span class="NAME">_stopAudioAnalysis</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>829</span> </span><span class="WHIT">                </span><span class="WHIT">
<span class='line'>830</span> </span><span class="WHIT">                </span><span class="COMM">// TODO: check if it is alright if we stop restarting the asr when reset_counter is greater than 3</span><span class="WHIT">
<span class='line'>831</span> </span><span class="WHIT">                </span><span class="COMM">// --> this would mean, we can never start the asr again in this instance... bad choice</span><span class="WHIT">
<span class='line'>832</span> </span><span class="WHIT">                </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">(</span><span class="NAME">aborted</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">recording</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>833</span> </span><span class="COMM">//                    restart_counter++;</span><span class="WHIT">
<span class='line'>834</span> </span><span class="WHIT">                    </span><span class="NAME">recognition.start</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>835</span> </span><span class="WHIT">                </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>836</span> </span><span class="WHIT">                </span><span class="COMM">//FIXME this is a HACK for the stopRecord function ...</span><span class="WHIT">
<span class='line'>837</span> </span><span class="WHIT">                </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">recognition._stopRecordCallback</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>838</span> </span><span class="WHIT">                	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">theCallback</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">recognition._stopRecordCallback</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>839</span> </span><span class="WHIT">                	</span><span class="COMM">//this is a "1-time callback" -> remove it...</span><span class="WHIT">
<span class='line'>840</span> </span><span class="WHIT">                	</span><span class="KEYW">delete</span><span class="WHIT"> </span><span class="NAME">recognition._stopRecordCallback</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>841</span> </span><span class="WHIT">                	</span><span class="COMM">//... and trigger the callback:</span><span class="WHIT">
<span class='line'>842</span> </span><span class="WHIT">                	</span><span class="NAME">theCallback.call</span><span class="PUNC">(</span><span class="NAME">recording</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">event</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>843</span> </span><span class="WHIT">                </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>844</span> </span><span class="WHIT">            </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>845</span> </span><span class="WHIT">            </span><span class="WHIT">
<span class='line'>846</span> </span><span class="WHIT">            </span><span class="COMM">/** 
<span class='line'>847</span>              * @type function
<span class='line'>848</span>              * @memberOf WebkitAudioInput.recognition#
<span class='line'>849</span>              */</span><span class="WHIT">
<span class='line'>850</span> </span><span class="WHIT">            </span><span class="NAME">recognition.onerror</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">default_error_function</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>851</span> </span><span class="WHIT">            </span><span class="WHIT">
<span class='line'>852</span> </span><span class="WHIT">            </span><span class="WHIT">
<span class='line'>853</span> </span><span class="WHIT">            </span><span class="COMM">/** 
<span class='line'>854</span>              * set maximum number of SpeechRecognitionAlternatives per result. 
<span class='line'>855</span>              * 
<span class='line'>856</span>              * TODO make this configurable
<span class='line'>857</span>              * 
<span class='line'>858</span>              * @type Number
<span class='line'>859</span>              * @memberOf WebkitAudioInput.recognition#
<span class='line'>860</span>              */</span><span class="WHIT">
<span class='line'>861</span> </span><span class="WHIT">            </span><span class="NAME">recognition.maxAlternatives</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>862</span> </span><span class="WHIT">            </span><span class="WHIT">
<span class='line'>863</span> </span><span class="WHIT">            </span><span class="COMM">//invoke the passed-in initializer-callback and export the public functions:</span><span class="WHIT">
<span class='line'>864</span> </span><span class="WHIT">			</span><span class="NAME">callBack</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>865</span> </span><span class="WHIT">				</span><span class="COMM">/**
<span class='line'>866</span> 				 * @public
<span class='line'>867</span> 				 * @memberOf WebkitAudioInput.prototype
<span class='line'>868</span> 				 * @see mmir.MediaManager#startRecord
<span class='line'>869</span> 				 */</span><span class="WHIT">
<span class='line'>870</span> </span><span class="WHIT">				</span><span class="NAME">startRecord</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">successCallback</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">failureCallback</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">intermediateResults</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>871</span> </span><span class="WHIT">                    </span><span class="WHIT">
<span class='line'>872</span> </span><span class="WHIT">                    </span><span class="COMM">// TODO: failureCallback parameter</span><span class="WHIT">
<span class='line'>873</span> </span><span class="WHIT">					</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">errMsg</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>874</span> </span><span class="WHIT">                    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">active</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>875</span> </span><span class="WHIT">                    	</span><span class="WHIT">
<span class='line'>876</span> </span><span class="WHIT">                    	</span><span class="NAME">errMsg</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">"[webkitAudioInput.Warn] Voice recognition already running."</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>877</span> </span><span class="WHIT">                        </span><span class="WHIT">
<span class='line'>878</span> </span><span class="WHIT">                        </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">failureCallback</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>879</span> </span><span class="WHIT">                        	</span><span class="WHIT">
<span class='line'>880</span> </span><span class="WHIT">                        	</span><span class="NAME">failureCallback</span><span class="PUNC">(</span><span class="NAME">errMsg</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>881</span> </span><span class="WHIT">                        	</span><span class="WHIT">
<span class='line'>882</span> </span><span class="WHIT">                        	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">loglevel</span><span class="WHIT"> </span><span class="PUNC">>=</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>883</span> </span><span class="WHIT">                                </span><span class="NAME">console.warn</span><span class="PUNC">(</span><span class="NAME">errMsg</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>884</span> </span><span class="WHIT">                            </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>885</span> </span><span class="WHIT">                        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>886</span> </span><span class="WHIT">                        </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>887</span> </span><span class="WHIT">                        	</span><span class="NAME">console.warn</span><span class="PUNC">(</span><span class="NAME">errMsg</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>888</span> </span><span class="WHIT">                        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>889</span> </span><span class="WHIT">                        </span><span class="KEYW">return</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>890</span> </span><span class="WHIT">                    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>891</span> </span><span class="WHIT">                    </span><span class="WHIT">
<span class='line'>892</span> </span><span class="WHIT">                    </span><span class="NAME">aborted</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>893</span> </span><span class="WHIT">                    </span><span class="NAME">recording</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>894</span> </span><span class="WHIT">                    </span><span class="NAME">error_counter</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>895</span> </span><span class="WHIT">                    </span><span class="WHIT">
<span class='line'>896</span> </span><span class="WHIT">                    </span><span class="NAME">_prevResult</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">void</span><span class="PUNC">(</span><span class="NUMB">0</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>897</span> </span><span class="WHIT">                    </span><span class="WHIT">
<span class='line'>898</span> </span><span class="WHIT">                    </span><span class="COMM">// flush any old results</span><span class="WHIT">
<span class='line'>899</span> </span><span class="WHIT">                    </span><span class="NAME">final_recognition_result</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">""</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>900</span> </span><span class="WHIT">                    </span><span class="WHIT">
<span class='line'>901</span> </span><span class="WHIT">                    </span><span class="COMM">// set intermediate_results - for access by stopRecord</span><span class="WHIT">
<span class='line'>902</span> </span><span class="WHIT">                    </span><span class="NAME">intermediate_results</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">intermediateResults</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>903</span> </span><span class="WHIT">                    </span><span class="WHIT">
<span class='line'>904</span> </span><span class="WHIT">                    </span><span class="COMM">// set recognition language</span><span class="WHIT">
<span class='line'>905</span> </span><span class="WHIT">                    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">langStr</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">languageManager.getLanguageConfig</span><span class="PUNC">(</span><span class="NAME">_pluginName</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>906</span> </span><span class="WHIT">                    </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">langStr</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>907</span> </span><span class="WHIT">                    	</span><span class="COMM">//default:</span><span class="WHIT">
<span class='line'>908</span> </span><span class="WHIT">                    	</span><span class="NAME">langStr</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">"en-US"</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>909</span> </span><span class="WHIT">                    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>910</span> </span><span class="WHIT">                	</span><span class="NAME">recognition.lang</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">langStr</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>911</span> </span><span class="WHIT">                    </span><span class="WHIT">
<span class='line'>912</span> </span><span class="WHIT">                    </span><span class="COMM">// do not stop recognition on silence</span><span class="WHIT">
<span class='line'>913</span> </span><span class="WHIT">                    </span><span class="NAME">recognition.continuous</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>914</span> </span><span class="WHIT">                    </span><span class="WHIT">
<span class='line'>915</span> </span><span class="WHIT">                    </span><span class="COMM">// get results continuously</span><span class="WHIT">
<span class='line'>916</span> </span><span class="WHIT">                    </span><span class="NAME">recognition.interimResults</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">loglevel</span><span class="WHIT"> </span><span class="PUNC">>=</span><span class="WHIT"> </span><span class="NUMB">4</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>917</span> 
<span class='line'>918</span> </span><span class="WHIT">					</span><span class="NAME">currentFailureCallback</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">failureCallback</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>919</span> </span><span class="WHIT">					</span><span class="NAME">currentSuccessCallback</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">successCallback</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>920</span> </span><span class="WHIT">                    </span><span class="WHIT">
<span class='line'>921</span> </span><span class="WHIT">                    </span><span class="NAME">recognition.onerror</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">default_error_function</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>922</span> </span><span class="WHIT">                    </span><span class="WHIT">
<span class='line'>923</span> </span><span class="WHIT">                    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">self</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>924</span> </span><span class="WHIT">                    </span><span class="WHIT">
<span class='line'>925</span> </span><span class="WHIT">                    </span><span class="COMM">// - see https://dvcs.w3.org/hg/speech-api/raw-file/tip/speechapi.html#speechreco-event</span><span class="WHIT">
<span class='line'>926</span> </span><span class="WHIT">                    </span><span class="NAME">recognition.onresult</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">event</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>927</span> </span><span class="WHIT">                        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">finalResult</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">''</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>928</span> </span><span class="WHIT">                        </span><span class="WHIT">
<span class='line'>929</span> </span><span class="WHIT">                        </span><span class="WHIT">
<span class='line'>930</span> </span><span class="WHIT">                        </span><span class="NAME">error_counter</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>931</span> 
<span class='line'>932</span> </span><span class="WHIT">                        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">evtResults</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">event.results</span><span class="PUNC">[</span><span class="NAME">event.resultIndex</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>933</span> </span><span class="WHIT">                        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">loglevel</span><span class="WHIT"> </span><span class="PUNC">>=</span><span class="WHIT"> </span><span class="NUMB">4</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>934</span> </span><span class="COMM">//                            console.debug("[webkitAudioInput.Debug] " + "interim: " + event.results[event.resultIndex][0][EVENT_RESULT_FIELD] + " ("+event.results[event.resultIndex][0].confidence+")");</span><span class="WHIT">
<span class='line'>935</span> </span><span class="WHIT">                            </span><span class="WHIT">
<span class='line'>936</span> </span><span class="WHIT">                            </span><span class="NAME">console.debug</span><span class="PUNC">(</span><span class="STRN">"[webkitAudioInput.Debug]  interim: "</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">JSON.stringify</span><span class="PUNC">(</span><span class="NAME">event.results</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>937</span> </span><span class="WHIT">                        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>938</span> 
<span class='line'>939</span> </span><span class="WHIT">                        </span><span class="COMM">// if event.results[event.resultIndex].isFinal is true, then there is a pause.</span><span class="WHIT">
<span class='line'>940</span> </span><span class="WHIT">                        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">evtResults.isFinal</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>941</span> </span><span class="WHIT">                            </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">loglevel</span><span class="WHIT"> </span><span class="PUNC">>=</span><span class="WHIT"> </span><span class="NUMB">4</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>942</span> </span><span class="WHIT">                                </span><span class="NAME">console.debug</span><span class="PUNC">(</span><span class="STRN">"[webkitAudioInput.Debug]  final"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>943</span> </span><span class="WHIT">                            </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>944</span> 
<span class='line'>945</span> </span><span class="WHIT">                            </span><span class="NAME">finalResult</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">evtResults</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NAME">EVENT_RESULT_FIELD</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>946</span> </span><span class="WHIT">                            </span><span class="WHIT">
<span class='line'>947</span> </span><span class="WHIT">                            </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">intermediate_results</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>948</span> </span><span class="WHIT">                            	</span><span class="WHIT">
<span class='line'>949</span> </span><span class="WHIT">                            	</span><span class="COMM">//INTERMEDIATE results mode: only message last ASR to callback:</span><span class="WHIT">
<span class='line'>950</span> </span><span class="WHIT">                            	</span><span class="WHIT">
<span class='line'>951</span> </span><span class="WHIT">                                </span><span class="COMM">// call callback method with result</span><span class="WHIT">
<span class='line'>952</span> </span><span class="WHIT">                                </span><span class="COMM">// final_recognition_result += " " + finalResult;</span><span class="WHIT">
<span class='line'>953</span> </span><span class="WHIT">                                </span><span class="NAME">final_recognition_result</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">finalResult</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>954</span> </span><span class="COMM">//                                currentSuccessCallback && currentSuccessCallback(finalResult);</span><span class="WHIT">
<span class='line'>955</span> </span><span class="WHIT">                                </span><span class="NAME">currentSuccessCallback</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">currentSuccessCallback.apply</span><span class="PUNC">(</span><span class="NAME">self</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">helper_extract_results</span><span class="PUNC">(</span><span class="NAME">evtResults</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>956</span> </span><span class="WHIT">                                </span><span class="WHIT">
<span class='line'>957</span> </span><span class="WHIT">                            </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>958</span> 
<span class='line'>959</span> </span><span class="WHIT">                            	</span><span class="COMM">//FINAL results mode: message collected ASR results to callback:</span><span class="WHIT">
<span class='line'>960</span> </span><span class="WHIT">                            	</span><span class="WHIT">
<span class='line'>961</span> </span><span class="WHIT">                                </span><span class="COMM">// final_recognition_result += " " + finalResult;</span><span class="WHIT">
<span class='line'>962</span> </span><span class="WHIT">                                </span><span class="NAME">final_recognition_result</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">finalResult</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>963</span> </span><span class="WHIT">                                </span><span class="WHIT">
<span class='line'>964</span> </span><span class="WHIT">                                </span><span class="COMM">//audio-input already closed --> this is the last invocation of the callback, so send final result</span><span class="WHIT">
<span class='line'>965</span> </span><span class="WHIT">                                </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">recording</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>966</span> </span><span class="WHIT">                                    </span><span class="NAME">currentSuccessCallback</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">currentSuccessCallback.call</span><span class="PUNC">(</span><span class="NAME">self</span><span class="PUNC">,</span><span class="NAME">final_recognition_result</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>967</span> </span><span class="WHIT">                                </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>968</span> </span><span class="WHIT">                            </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>969</span> </span><span class="WHIT">                            </span><span class="WHIT">
<span class='line'>970</span> </span><span class="WHIT">                        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>971</span> </span><span class="WHIT">                        </span><span class="COMM">//for intermediate result (only if we have a callback):</span><span class="WHIT">
<span class='line'>972</span> </span><span class="WHIT">                        </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">intermediate_results</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">currentSuccessCallback</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>973</span> </span><span class="WHIT">                            </span><span class="NAME">currentSuccessCallback.apply</span><span class="PUNC">(</span><span class="NAME">self</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">helper_extract_results</span><span class="PUNC">(</span><span class="NAME">evtResults</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>974</span> </span><span class="WHIT">                        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>975</span> </span><span class="WHIT">                    </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>976</span> </span><span class="WHIT">                    </span><span class="WHIT">
<span class='line'>977</span> </span><span class="WHIT">                    </span><span class="COMM">// start the recognition</span><span class="WHIT">
<span class='line'>978</span> </span><span class="WHIT">                    </span><span class="KEYW">try</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>979</span> </span><span class="WHIT">                    	</span><span class="WHIT">
<span class='line'>980</span> </span><span class="WHIT">                    	</span><span class="NAME">recognition.start</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>981</span> </span><span class="WHIT">                    	</span><span class="WHIT">
<span class='line'>982</span> </span><span class="WHIT">                    </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">catch</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">exc</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>983</span> </span><span class="WHIT">                    	</span><span class="WHIT">
<span class='line'>984</span> </span><span class="WHIT">                    	</span><span class="NAME">errMsg</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">"[webkitAudioInput.Error] Could not start voice recognition: "</span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">exc</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>985</span> </span><span class="WHIT">                        </span><span class="WHIT">
<span class='line'>986</span> </span><span class="WHIT">                        </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">failureCallback</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>987</span> </span><span class="WHIT">                        	</span><span class="WHIT">
<span class='line'>988</span> </span><span class="WHIT">                        	</span><span class="NAME">failureCallback</span><span class="PUNC">(</span><span class="NAME">errMsg</span><span class="PUNC">,</span><span class="NAME">exc</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>989</span> 
<span class='line'>990</span> </span><span class="WHIT">                            </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">loglevel</span><span class="WHIT"> </span><span class="PUNC">>=</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>991</span> </span><span class="WHIT">                                </span><span class="NAME">console.error</span><span class="PUNC">(</span><span class="NAME">errMsg</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">exc</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>992</span> </span><span class="WHIT">                            </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>993</span> </span><span class="WHIT">                        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>994</span> </span><span class="WHIT">                        </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>995</span> </span><span class="WHIT">                        	</span><span class="NAME">console.error</span><span class="PUNC">(</span><span class="NAME">errMsg</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">exc</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>996</span> </span><span class="WHIT">                        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>997</span> </span><span class="WHIT">                    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>998</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>999</span> </span><span class="WHIT">				</span><span class="COMM">/**
<span class='line'>1000</span> 				 * @public
<span class='line'>1001</span> 				 * @memberOf WebkitAudioInput.prototype
<span class='line'>1002</span> 				 * @see mmir.MediaManager#stopRecord
<span class='line'>1003</span> 				 */</span><span class="WHIT">
<span class='line'>1004</span> </span><span class="WHIT">				</span><span class="NAME">stopRecord</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">successCallback</span><span class="PUNC">,</span><span class="NAME">failureCallback</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1005</span> </span><span class="WHIT">                </span><span class="COMM">// TODO: at end of recording return whole recognized stuff in successcallback</span><span class="WHIT">
<span class='line'>1006</span> </span><span class="WHIT">                    </span><span class="NAME">recording</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1007</span> </span><span class="WHIT">                    </span><span class="WHIT">
<span class='line'>1008</span> </span><span class="WHIT">                    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">isSuccessTriggered</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1009</span> </span><span class="WHIT">                    </span><span class="WHIT">
<span class='line'>1010</span> </span><span class="WHIT">                    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">self</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1011</span> </span><span class="WHIT">                    </span><span class="WHIT">
<span class='line'>1012</span> </span><span class="WHIT">                    </span><span class="COMM">// recognize (recognition.continuous == true) or stopRecord (recognition.continuous == false)</span><span class="WHIT">
<span class='line'>1013</span> </span><span class="WHIT">                    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">recognition.continuous</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1014</span> </span><span class="WHIT">                    	</span><span class="WHIT">
<span class='line'>1015</span> </span><span class="WHIT">                        </span><span class="NAME">recognition.onresult</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">event</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1016</span> </span><span class="WHIT">                            </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">finalResult</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">''</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1017</span> 
<span class='line'>1018</span> </span><span class="WHIT">                            </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">loglevel</span><span class="WHIT"> </span><span class="PUNC">>=</span><span class="WHIT"> </span><span class="NUMB">4</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1019</span> </span><span class="WHIT">                                </span><span class="NAME">console.debug</span><span class="PUNC">(</span><span class="STRN">"[webkitAudioInput.Debug] interim: "</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">event.results</span><span class="PUNC">[</span><span class="NAME">event.resultIndex</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NAME">EVENT_RESULT_FIELD</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1020</span> </span><span class="WHIT">                            </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1021</span> </span><span class="WHIT">                            </span><span class="WHIT">
<span class='line'>1022</span> </span><span class="WHIT">                            </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">evtResults</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">event.results</span><span class="PUNC">[</span><span class="NAME">event.resultIndex</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1023</span> </span><span class="WHIT">                            </span><span class="COMM">// if event.results[event.resultIndex].isFinal is true, then there is a pause.</span><span class="WHIT">
<span class='line'>1024</span> </span><span class="WHIT">                            </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">evtResults.isFinal</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1025</span> </span><span class="WHIT">                                </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">loglevel</span><span class="WHIT"> </span><span class="PUNC">>=</span><span class="WHIT"> </span><span class="NUMB">4</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1026</span> </span><span class="WHIT">                                    </span><span class="NAME">console.debug</span><span class="PUNC">(</span><span class="STRN">"[webkitAudioInput.Debug] final"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1027</span> </span><span class="WHIT">                                </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1028</span> 
<span class='line'>1029</span> </span><span class="WHIT">                                </span><span class="NAME">finalResult</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">evtResults</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NAME">EVENT_RESULT_FIELD</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1030</span> </span><span class="WHIT">                                </span><span class="WHIT">
<span class='line'>1031</span> </span><span class="WHIT">                                </span><span class="COMM">// is it called for the last time (recording == false)</span><span class="WHIT">
<span class='line'>1032</span> </span><span class="WHIT">                                </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">recording</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1033</span> </span><span class="WHIT">                                    </span><span class="NAME">final_recognition_result</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">finalResult</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1034</span> </span><span class="WHIT">                                    </span><span class="WHIT">
<span class='line'>1035</span> </span><span class="WHIT">                                    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">intermediate_results</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1036</span> </span><span class="COMM">//                                        currentSuccessCallback && currentSuccessCallback(finalResult);</span><span class="WHIT">
<span class='line'>1037</span> </span><span class="WHIT">                                    	</span><span class="NAME">currentSuccessCallback</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">currentSuccessCallback.apply</span><span class="PUNC">(</span><span class="NAME">self</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">helper_extract_results</span><span class="PUNC">(</span><span class="NAME">evtResults</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1038</span> </span><span class="WHIT">                                    </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1039</span> </span><span class="WHIT">                                        </span><span class="NAME">currentSuccessCallback</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">currentSuccessCallback.call</span><span class="PUNC">(</span><span class="NAME">self</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">final_recognition_result</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1040</span> </span><span class="WHIT">                                    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1041</span> </span><span class="WHIT">                                    </span><span class="WHIT">
<span class='line'>1042</span> </span><span class="WHIT">                                    </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">successCallback</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1043</span> </span><span class="WHIT">                                    	</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">isSuccessTriggered</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1044</span> </span><span class="WHIT">                                    		</span><span class="NAME">console.warn</span><span class="PUNC">(</span><span class="STRN">'stopRecord: success callback was already triggered!'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="COMM">//FIXME debug</span><span class="WHIT">
<span class='line'>1045</span> </span><span class="WHIT">                                    	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1046</span> </span><span class="WHIT">                                    	</span><span class="NAME">isSuccessTriggered</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1047</span> </span><span class="WHIT">                                    	</span><span class="NAME">successCallback.call</span><span class="PUNC">(</span><span class="NAME">self</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">final_recognition_result</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1048</span> </span><span class="WHIT">                                    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1049</span> </span><span class="WHIT">                                </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1050</span> </span><span class="WHIT">                                    </span><span class="COMM">// final_recognition_result += " " + finalResult;</span><span class="WHIT">
<span class='line'>1051</span> </span><span class="WHIT">                                    </span><span class="NAME">final_recognition_result</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">finalResult</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1052</span> </span><span class="WHIT">                                    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">intermediate_results</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1053</span> </span><span class="WHIT">                                        </span><span class="NAME">currentSuccessCallback</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">currentSuccessCallback.call</span><span class="PUNC">(</span><span class="NAME">self</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">finalResult</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1054</span> </span><span class="WHIT">                                    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1055</span> </span><span class="WHIT">                                </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1056</span> </span><span class="WHIT">                                </span><span class="WHIT">
<span class='line'>1057</span> </span><span class="WHIT">                            </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1058</span> </span><span class="WHIT">                            </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1059</span> </span><span class="WHIT">                            	</span><span class="NAME">currentSuccessCallback</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">currentSuccessCallback.apply</span><span class="PUNC">(</span><span class="NAME">self</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">helper_extract_results</span><span class="PUNC">(</span><span class="NAME">evtResults</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1060</span> </span><span class="WHIT">                            </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1061</span> </span><span class="WHIT">                        </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1062</span> </span><span class="WHIT">                    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1063</span> </span><span class="WHIT">                    </span><span class="COMM">// TODO: recognition.onstop = function(){successCallback}</span><span class="WHIT">
<span class='line'>1064</span> </span><span class="WHIT">                    </span><span class="WHIT">
<span class='line'>1065</span> </span><span class="WHIT">                    </span><span class="COMM">//HACK: set an "internal" callback, that will be checked in the onend-listener (see above)</span><span class="WHIT">
<span class='line'>1066</span> </span><span class="WHIT">                    </span><span class="COMM">//		(NOTE: the onstop()-listener does not seem to get called ...)</span><span class="WHIT">
<span class='line'>1067</span> </span><span class="WHIT">                    </span><span class="NAME">recognition._stopRecordCallback</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">evt</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1068</span> </span><span class="WHIT">                    	</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">successCallback</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="NAME">isSuccessTriggered</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1069</span> </span><span class="COMM">//                    		console.debug('stopRecord: calling success callback onstop (without last ASR result)');//FIXM debug</span><span class="WHIT">
<span class='line'>1070</span> </span><span class="WHIT">                    		</span><span class="NAME">isSuccessTriggered</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1071</span> </span><span class="WHIT">                        	</span><span class="NAME">successCallback.call</span><span class="PUNC">(</span><span class="NAME">self</span><span class="PUNC">,</span><span class="STRN">''</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="NUMB">1</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">'RECORDING_DONE'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1072</span> </span><span class="WHIT">                        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1073</span> </span><span class="WHIT">                    </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1074</span> </span><span class="WHIT">                    </span><span class="WHIT">
<span class='line'>1075</span> </span><span class="WHIT">                    </span><span class="KEYW">try</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1076</span> </span><span class="WHIT">                    	</span><span class="WHIT">
<span class='line'>1077</span> </span><span class="WHIT">                    	</span><span class="NAME">recognition.stop</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1078</span> </span><span class="WHIT">                    	</span><span class="WHIT">
<span class='line'>1079</span> </span><span class="WHIT">                    </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">catch</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">exc</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1080</span> </span><span class="WHIT">                    	</span><span class="WHIT">
<span class='line'>1081</span> </span><span class="WHIT">                    	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">errMsg</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">"[webkitAudioInput.Error] Could not stop voice recognition: "</span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">exc</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1082</span> </span><span class="WHIT">                        </span><span class="WHIT">
<span class='line'>1083</span> </span><span class="WHIT">                        </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">failureCallback</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1084</span> </span><span class="WHIT">                        	</span><span class="WHIT">
<span class='line'>1085</span> </span><span class="WHIT">                        	</span><span class="NAME">failureCallback</span><span class="PUNC">(</span><span class="NAME">errMsg</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1086</span> </span><span class="WHIT">                        	</span><span class="WHIT">
<span class='line'>1087</span> </span><span class="WHIT">                        	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">loglevel</span><span class="WHIT"> </span><span class="PUNC">>=</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1088</span> </span><span class="WHIT">                                </span><span class="NAME">console.error</span><span class="PUNC">(</span><span class="NAME">errMsg</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">exc</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1089</span> </span><span class="WHIT">                            </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1090</span> </span><span class="WHIT">                        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1091</span> </span><span class="WHIT">                        </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1092</span> </span><span class="WHIT">                        	</span><span class="NAME">console.error</span><span class="PUNC">(</span><span class="NAME">errMsg</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">exc</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1093</span> </span><span class="WHIT">                        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1094</span> </span><span class="WHIT">                    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1095</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1096</span> </span><span class="WHIT">                </span><span class="WHIT">
<span class='line'>1097</span> 
<span class='line'>1098</span> </span><span class="WHIT">				</span><span class="COMM">/**
<span class='line'>1099</span> 				 * 
<span class='line'>1100</span> 				 * &lt;p>
<span class='line'>1101</span> 				 * NOTE: doesn't require interimResult - because it stops after first pause; would make no sense
<span class='line'>1102</span> 				 * 
<span class='line'>1103</span> 				 * &lt;p>
<span class='line'>1104</span> 				 * NOTE:  no end event, if recognize() is stopped via stopRecord()
<span class='line'>1105</span> 				 * 
<span class='line'>1106</span> 				 * @public
<span class='line'>1107</span> 				 * @memberOf WebkitAudioInput.prototype
<span class='line'>1108</span> 				 * @see mmir.MediaManager#recognize
<span class='line'>1109</span> 				 */</span><span class="WHIT">
<span class='line'>1110</span> </span><span class="WHIT">				</span><span class="NAME">recognize</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">successCallback</span><span class="PUNC">,</span><span class="NAME">failureCallback</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1111</span> </span><span class="WHIT">					</span><span class="WHIT">
<span class='line'>1112</span> </span><span class="WHIT">                    </span><span class="NAME">console.warn</span><span class="PUNC">(</span><span class="STRN">"DO NOT USE AT THE MOMENT\nUnexpected behavior: if recognition is stopped (via 'stopRecord()'), the 'end' is not thrown. The recognizer is still active, but not usable."</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1113</span> </span><span class="WHIT">                </span><span class="WHIT">
<span class='line'>1114</span> </span><span class="WHIT">                    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">errMsg</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1115</span> </span><span class="WHIT">                    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">active</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1116</span> </span><span class="WHIT">                    	</span><span class="WHIT">
<span class='line'>1117</span> </span><span class="WHIT">                    	</span><span class="NAME">errMsg</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">"[webkitAudioInput.Warn] Voice recognition already running."</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1118</span> </span><span class="WHIT">                        </span><span class="WHIT">
<span class='line'>1119</span> </span><span class="WHIT">                        </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">failureCallback</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1120</span> </span><span class="WHIT">                        	</span><span class="WHIT">
<span class='line'>1121</span> </span><span class="WHIT">                        	</span><span class="NAME">failureCallback</span><span class="PUNC">(</span><span class="NAME">errMsg</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1122</span> </span><span class="WHIT">                        	</span><span class="WHIT">
<span class='line'>1123</span> </span><span class="WHIT">                        	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">loglevel</span><span class="WHIT"> </span><span class="PUNC">>=</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1124</span> </span><span class="WHIT">                                </span><span class="NAME">console.warn</span><span class="PUNC">(</span><span class="NAME">errMsg</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1125</span> </span><span class="WHIT">                            </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1126</span> </span><span class="WHIT">                        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1127</span> </span><span class="WHIT">                        </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1128</span> </span><span class="WHIT">                        	</span><span class="NAME">console.warn</span><span class="PUNC">(</span><span class="NAME">errMsg</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1129</span> </span><span class="WHIT">                        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1130</span> </span><span class="WHIT">                        </span><span class="KEYW">return</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1131</span> </span><span class="WHIT">                    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1132</span> </span><span class="WHIT">                    </span><span class="WHIT">
<span class='line'>1133</span> </span><span class="WHIT">                    </span><span class="NAME">aborted</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1134</span> </span><span class="WHIT">                    </span><span class="NAME">recording</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1135</span> </span><span class="WHIT">                    </span><span class="NAME">error_counter</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1136</span> </span><span class="WHIT">                    </span><span class="WHIT">
<span class='line'>1137</span> </span><span class="WHIT">                    </span><span class="NAME">_prevResult</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">void</span><span class="PUNC">(</span><span class="NUMB">0</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1138</span> </span><span class="WHIT">                    </span><span class="WHIT">
<span class='line'>1139</span> </span><span class="WHIT">                    </span><span class="COMM">// flush any old results</span><span class="WHIT">
<span class='line'>1140</span> </span><span class="WHIT">                    </span><span class="NAME">final_recognition_result</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">""</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1141</span> </span><span class="WHIT">                    </span><span class="WHIT">
<span class='line'>1142</span> </span><span class="WHIT">                    </span><span class="COMM">// recognition.lang = "en-US";</span><span class="WHIT">
<span class='line'>1143</span> </span><span class="WHIT">                    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">langStr</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">languageManager.getLanguageConfig</span><span class="PUNC">(</span><span class="NAME">_pluginName</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1144</span> </span><span class="WHIT">                    </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">langStr</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1145</span> </span><span class="WHIT">                    	</span><span class="COMM">//default:</span><span class="WHIT">
<span class='line'>1146</span> </span><span class="WHIT">                    	</span><span class="NAME">langStr</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">"en-US"</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1147</span> </span><span class="WHIT">                    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1148</span> </span><span class="WHIT">                	</span><span class="NAME">recognition.lang</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">langStr</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1149</span> 
<span class='line'>1150</span> </span><span class="WHIT">                    </span><span class="COMM">// stop recognition on silence</span><span class="WHIT">
<span class='line'>1151</span> </span><span class="WHIT">                    </span><span class="NAME">recognition.continuous</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1152</span> </span><span class="WHIT">                    </span><span class="WHIT">
<span class='line'>1153</span> </span><span class="WHIT">                    </span><span class="COMM">// not needed for recognize</span><span class="WHIT">
<span class='line'>1154</span> </span><span class="WHIT">                    </span><span class="COMM">// // set intermediate_results - for access by stopRecord</span><span class="WHIT">
<span class='line'>1155</span> </span><span class="WHIT">                    </span><span class="NAME">recognition.interimResults</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">loglevel</span><span class="WHIT"> </span><span class="PUNC">>=</span><span class="WHIT"> </span><span class="NUMB">4</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1156</span> 
<span class='line'>1157</span> </span><span class="WHIT">					</span><span class="NAME">currentFailureCallback</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">failureCallback</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1158</span> </span><span class="WHIT">					</span><span class="NAME">currentSuccessCallback</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">successCallback</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1159</span> </span><span class="WHIT">                    </span><span class="WHIT">
<span class='line'>1160</span> </span><span class="WHIT">                    </span><span class="NAME">recognition.onerror</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">default_error_function</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1161</span> </span><span class="WHIT">                    </span><span class="WHIT">
<span class='line'>1162</span> </span><span class="WHIT">                    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">self</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1163</span> </span><span class="WHIT">                    </span><span class="COMM">// - see https://dvcs.w3.org/hg/speech-api/raw-file/tip/speechapi.html#speechreco-event</span><span class="WHIT">
<span class='line'>1164</span> </span><span class="WHIT">                    </span><span class="NAME">recognition.onresult</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">event</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1165</span> </span><span class="COMM">//                        var finalResult = '';</span><span class="WHIT">
<span class='line'>1166</span> 
<span class='line'>1167</span> </span><span class="WHIT">                        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">loglevel</span><span class="WHIT"> </span><span class="PUNC">>=</span><span class="WHIT"> </span><span class="NUMB">4</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1168</span> </span><span class="WHIT">                            </span><span class="NAME">console.debug</span><span class="PUNC">(</span><span class="STRN">"[webkitAudioInput.Debug] "</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">"interim: "</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">event.results</span><span class="PUNC">[</span><span class="NAME">event.resultIndex</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NAME">EVENT_RESULT_FIELD</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1169</span> </span><span class="WHIT">                        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1170</span> 
<span class='line'>1171</span> </span><span class="WHIT">                        </span><span class="COMM">// if event.results[event.resultIndex].isFinal is true, then there is a pause.</span><span class="WHIT">
<span class='line'>1172</span> </span><span class="WHIT">                        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">event.results</span><span class="PUNC">[</span><span class="NAME">event.resultIndex</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">isFinal</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1173</span> </span><span class="WHIT">                            </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">loglevel</span><span class="WHIT"> </span><span class="PUNC">>=</span><span class="WHIT"> </span><span class="NUMB">4</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1174</span> </span><span class="WHIT">                                </span><span class="NAME">console.debug</span><span class="PUNC">(</span><span class="STRN">"[webkitAudioInput.Debug] "</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">"final"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1175</span> </span><span class="WHIT">                            </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1176</span> 
<span class='line'>1177</span> </span><span class="WHIT">                            </span><span class="COMM">//stop recording - finish after one sentence!</span><span class="WHIT">
<span class='line'>1178</span> </span><span class="WHIT">                            </span><span class="COMM">//NOTE do this before calling helper_extract_results(), in order to make the result type FINAL</span><span class="WHIT">
<span class='line'>1179</span> </span><span class="WHIT">                            </span><span class="NAME">recording</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1180</span> </span><span class="WHIT">                            </span><span class="WHIT">
<span class='line'>1181</span> </span><span class="WHIT">                            </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">returnArgs</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">helper_extract_results</span><span class="PUNC">(</span><span class="NAME">event.results</span><span class="PUNC">[</span><span class="NAME">event.resultIndex</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1182</span> </span><span class="WHIT">                            </span><span class="WHIT">
<span class='line'>1183</span> </span><span class="WHIT">                            </span><span class="COMM">// TODO: dirty hack - somehow it does not throw end event after recognition if recognize is used</span><span class="WHIT">
<span class='line'>1184</span> </span><span class="WHIT">                            </span><span class="NAME">self.cancelRecognition</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1185</span> </span><span class="WHIT">                            </span><span class="NAME">currentSuccessCallback</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">currentSuccessCallback.apply</span><span class="PUNC">(</span><span class="NAME">self</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">returnArgs</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="COMM">//finalResult);</span><span class="WHIT">
<span class='line'>1186</span> </span><span class="WHIT">                        </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="WHIT">
<span class='line'>1187</span> </span><span class="WHIT">                    </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1188</span> </span><span class="WHIT">                    </span><span class="WHIT">
<span class='line'>1189</span> </span><span class="WHIT">                    </span><span class="COMM">// start the recognition</span><span class="WHIT">
<span class='line'>1190</span> </span><span class="WHIT">                    </span><span class="KEYW">try</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1191</span> </span><span class="WHIT">                    	</span><span class="WHIT">
<span class='line'>1192</span> </span><span class="WHIT">                    	</span><span class="NAME">recognition.start</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1193</span> </span><span class="WHIT">                    	</span><span class="WHIT">
<span class='line'>1194</span> </span><span class="WHIT">                    </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">catch</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">exc</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1195</span> </span><span class="WHIT">                    	</span><span class="WHIT">
<span class='line'>1196</span> </span><span class="WHIT">                    	</span><span class="NAME">errMsg</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">"[webkitAudioInput.Error] Could not start voice recognition: "</span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">exc</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1197</span> </span><span class="WHIT">                        </span><span class="WHIT">
<span class='line'>1198</span> </span><span class="WHIT">                        </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">failureCallback</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1199</span> </span><span class="WHIT">                        	</span><span class="WHIT">
<span class='line'>1200</span> </span><span class="WHIT">                        	</span><span class="NAME">failureCallback</span><span class="PUNC">(</span><span class="NAME">errMsg</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">exc</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1201</span> 
<span class='line'>1202</span> </span><span class="WHIT">                            </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">loglevel</span><span class="WHIT"> </span><span class="PUNC">>=</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1203</span> </span><span class="WHIT">                                </span><span class="NAME">console.error</span><span class="PUNC">(</span><span class="NAME">errMsg</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">exc</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1204</span> </span><span class="WHIT">                            </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1205</span> </span><span class="WHIT">                        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1206</span> </span><span class="WHIT">                        </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1207</span> </span><span class="WHIT">                        	</span><span class="NAME">console.error</span><span class="PUNC">(</span><span class="NAME">errMsg</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">exc</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1208</span> </span><span class="WHIT">                        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1209</span> </span><span class="WHIT">                    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1210</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1211</span> </span><span class="WHIT">				</span><span class="COMM">/**
<span class='line'>1212</span> 				 * @public
<span class='line'>1213</span> 				 * @memberOf WebkitAudioInput.prototype
<span class='line'>1214</span> 				 * @see mmir.MediaManager#cancelRecognition
<span class='line'>1215</span> 				 */</span><span class="WHIT">
<span class='line'>1216</span> </span><span class="WHIT">                </span><span class="NAME">cancelRecognition</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">successCallback</span><span class="PUNC">,</span><span class="NAME">failureCallback</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1217</span> </span><span class="WHIT">                    </span><span class="NAME">recording</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1218</span> </span><span class="WHIT">                    </span><span class="NAME">aborted</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1219</span> </span><span class="WHIT">                    </span><span class="NAME">error_counter</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1220</span> </span><span class="WHIT">                    </span><span class="WHIT">
<span class='line'>1221</span> </span><span class="WHIT">                    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">self</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1222</span> </span><span class="WHIT">                    </span><span class="COMM">// callback used if an error occurred - includes abort</span><span class="WHIT">
<span class='line'>1223</span> </span><span class="WHIT">                    </span><span class="COMM">// gets event as argument - see https://dvcs.w3.org/hg/speech-api/raw-file/tip/speechapi.html#speechreco-error</span><span class="WHIT">
<span class='line'>1224</span> </span><span class="WHIT">                    </span><span class="COMM">// * if aborted - call successCallback</span><span class="WHIT">
<span class='line'>1225</span> 
<span class='line'>1226</span> </span><span class="WHIT">                    </span><span class="NAME">recognition.onerror</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">event</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1227</span> </span><span class="WHIT">                        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">(</span><span class="NAME">event.error</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">"aborted"</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">aborted</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1228</span> </span><span class="WHIT">                            </span><span class="NAME">aborted</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1229</span> </span><span class="WHIT">                            </span><span class="NAME">recognition.onerror</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">default_error_function</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1230</span> </span><span class="WHIT">                            </span><span class="NAME">successCallback</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">successCallback.call</span><span class="PUNC">(</span><span class="NAME">self</span><span class="PUNC">,</span><span class="NAME">event.error</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1231</span> </span><span class="WHIT">                        </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1232</span> </span><span class="WHIT">                            </span><span class="COMM">// currentFailureCallback(event.error);</span><span class="WHIT">
<span class='line'>1233</span> </span><span class="WHIT">                            </span><span class="NAME">default_error_function.call</span><span class="PUNC">(</span><span class="NAME">self</span><span class="PUNC">,</span><span class="NAME">event.error</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1234</span> </span><span class="WHIT">                        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1235</span> </span><span class="WHIT">                    </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1236</span> 
<span class='line'>1237</span> </span><span class="WHIT">                    </span><span class="NAME">recognition.abort</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1238</span> </span><span class="WHIT">                </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1239</span> </span><span class="WHIT">                </span><span class="COMM">/**
<span class='line'>1240</span>                  * for debugging - NOTE use with caution, be removed in the future
<span class='line'>1241</span> 				 * @private
<span class='line'>1242</span> 				 * @memberOf WebkitAudioInput.prototype
<span class='line'>1243</span> 				 */</span><span class="WHIT">
<span class='line'>1244</span> </span><span class="WHIT">                </span><span class="NAME">getLoglevel</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1245</span> </span><span class="WHIT">                    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">loglevel</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1246</span> </span><span class="WHIT">                </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1247</span> </span><span class="WHIT">                </span><span class="COMM">/**
<span class='line'>1248</span>                  * for debugging - NOTE use with caution, be removed in the future
<span class='line'>1249</span>                  * @default 0: set loglevel to 0
<span class='line'>1250</span> 				 * @private
<span class='line'>1251</span> 				 * @memberOf WebkitAudioInput.prototype
<span class='line'>1252</span> 				 */</span><span class="WHIT">
<span class='line'>1253</span> </span><span class="WHIT">                </span><span class="NAME">setLoglevel</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">logvalue</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1254</span> </span><span class="WHIT">                    </span><span class="NAME">loglevel</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">logvalue</span><span class="WHIT"> </span><span class="PUNC">|</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1255</span> </span><span class="WHIT">                    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">loglevel</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1256</span> </span><span class="WHIT">                </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1257</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1258</span> </span><span class="WHIT">		    		</span><span class="WHIT">
<span class='line'>1259</span> </span><span class="WHIT">		    		</span><span class="WHIT">
<span class='line'>1260</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1261</span> </span><span class="WHIT">		</span><span class="WHIT">
<span class='line'>1262</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1263</span> </span></pre></body></html>